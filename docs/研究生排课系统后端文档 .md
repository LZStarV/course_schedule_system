# 研究生排课系统 - 后端设计文档

## 1. 文档概述

### 1.1 文档目的

本文档明确研究生排课系统后端的技术架构、目录结构、核心模块设计、接口规范及部署方案，为AI工具生成后端代码和开发人员完善MVP提供清晰、可执行的技术指南，确保后端开发高效对齐业务需求与前端交互。

### 1.2 核心目标

- 基于RBAC权限模型，实现多角色（学生、教师、管理员、超级管理员）的权限隔离与数据范围控制

- 支撑选课、课程管理、成绩录入、统计分析等核心业务流程，保证高并发场景下的稳定性

- 提供统一的 RPC 接口，实现与前端的无缝对接

- 集成数据验证、身份认证、日志审计等安全机制，满足业务文档中的安全性要求

- 数据库通过容器完成迁移与初始化；应用以本机开发为主

### 1.3 适用范围

- 后端技术栈选型落地与项目结构搭建

- 核心业务模块与服务实现

- 接口设计与参数校验

- 数据模型与数据库交互（基于Sequelize ORM）

- 中间件开发与集成

- 缓存策略与性能优化

- 部署配置与打包流程

## 2. 技术栈详情

### 2.1 核心技术栈

| 技术类别   | 选型明细                | 版本要求 | 核心用途                                     |
| ---------- | ----------------------- | -------- | -------------------------------------------- |
| 构建工具   | esbuild                 | 0.17+    | 快速编译TypeScript代码，提升构建效率         |
| 后端框架   | NestJS                  | 9+       | 模块化架构、依赖注入、中间件支持             |
| 类型检查   | TypeScript              | 4.9+     | 类型定义、代码健壮性保障                     |
| 数据验证   | Zod                     | 3+       | 请求参数校验、数据格式验证                   |
| 身份认证   | JWT                     | 9+       | 无状态身份认证、Token生成与验证              |
| HTTP客户端 | undici                  | 5+       | 高效HTTP请求发送（内部服务调用）             |
| ORM框架    | Sequelize               | 6+       | 数据库交互、模型定义、关联查询               |
| 核心数据库 | PostgreSQL              | 15+      | 存储结构化业务数据（用户、课程、选课记录等） |
| 缓存数据库 | Redis                   | 7+       | 会话缓存、热点数据缓存、分布式锁、限流       |
| 包管理     | pnpm                    | 8+       | 配合monorepo管理依赖、共享包复用             |
| 部署工具   | Docker + Docker Compose | 20+      | 容器化部署、环境一致性保障                   |

### 2.2 辅助工具

- 日志工具：winston（日志收集与输出）

- 接口文档：Swagger（NestJS集成，自动生成接口文档）

- 数据库迁移：Sequelize Migrations（数据库表结构版本控制）

- 配置管理：packages/config（统一配置来源）

- 代码规范：ESLint + Prettier（统一代码风格）

- 测试工具：Jest（单元测试、集成测试）

## 3. 项目目录结构

### 3.1 整体目录（monorepo结构）

```Plain Text
course_schedule_system/
├── package.json                # 根项目配置（pnpm workspace）
├── pnpm-workspace.yaml         # monorepo工作区配置
├── tsconfig.json               # 全局TS配置
├── .eslintrc.js                # 全局ESLint配置
├── .prettierrc                 # Prettier配置
├── apps/
│   ├── backend/                # 后端子项目（核心目录）
│   └── frontend/               # 前端子项目（由前端文档定义）
└── packages/                   # 共享包
    ├── shared-types/           # 前后端共享类型定义（如接口请求/响应类型）
    └── shared-utils/           # 通用工具函数（如日期处理、加密工具）
```

### 3.2 后端子项目目录（apps/backend）

```Plain Text
apps/backend/
├── package.json                # 后端项目配置
├── tsconfig.json               # 后端TS配置
├── esbuild.config.js           # esbuild构建配置
├── src/
│   ├── main.ts                 # 入口文件（初始化NestJS应用、加载模块）
│   ├── app.module.ts           # 根模块（导入所有业务模块、配置模块）
│   ├── modules/                # 业务模块目录（按功能划分，模块自包含）
│   │   ├── user/               # 用户模块（user.module.ts/user.controller.ts/user.service.ts）
│   │   ├── course/             # 课程模块（course.*）
│   │   ├── enrollment/         # 选课模块（enrollment.*）
│   │   ├── grade/              # 成绩模块（grade.*）
│   │   ├── analytics/          # 统计分析模块（analytics.*）
│   │   ├── system/             # 系统管理模块（system.*）
│   │   └── message/            # 消息通知模块（message.*）
│   ├── common/                 # 通用层（DTO/Guards/Middleware/Filters/Config/Utils）
│   ├── models/                 # 数据模型目录（Sequelize Model）
│   │   ├── user.model.ts       # 用户模型
│   │   ├── course.model.ts     # 课程模型
│   │   ├── enrollment.model.ts # 选课模型
│   │   └── ...                 # 其他模型
│   ├── dto/                    # 数据传输对象（请求/响应格式定义）
│   │   ├── auth.dto.ts         # 认证相关DTO
│   │   ├── user.dto.ts         # 用户相关DTO
│   │   └── ...                 # 其他DTO
│   ├── middleware/             # 中间件目录
│   │   ├── auth.middleware.ts  # JWT认证中间件
│   │   ├── permission.middleware.ts # 权限控制中间件
│   │   ├── validation.middleware.ts # 请求验证中间件
│   │   ├── logger.middleware.ts # 日志中间件
│   │   └── rate-limit.middleware.ts # 限流中间件
│   ├── guards/                 # 守卫目录（NestJS权限守卫）
│   │   ├── auth.guard.ts       # 登录守卫
│   │   └── permission.guard.ts # 操作权限守卫
│   ├── filters/                # 异常过滤器目录
│   │   ├── http-exception.filter.ts # HTTP异常过滤器
│   │   └── business-exception.filter.ts # 业务异常过滤器
│   ├── pipes/                  # 管道目录（数据转换、验证）
│   │   ├── validation.pipe.ts  # Zod验证管道
│   │   └── transform.pipe.ts   # 数据转换管道
│   ├── config/                 # 配置目录
│   │   ├── database.config.ts  # 数据库配置
│   │   ├── redis.config.ts     # Redis配置
│   │   ├── jwt.config.ts       # JWT配置
│   │   └── app.config.ts       # 应用配置
│   ├── utils/                  # 工具函数目录
│   │   ├── logger.util.ts      # 日志工具
│   │   ├── crypto.util.ts      # 加密工具
│   │   ├── date.util.ts        # 日期工具
│   │   └── redis.util.ts       # Redis工具
│   ├── constants/              # 常量目录
│   │   ├── error-code.constant.ts # 错误码常量
│   │   ├── role.constant.ts    # 角色常量
│   │   └── cache-key.constant.ts # 缓存键常量
│   └── constants/              # 常量配置（错误码、角色、缓存键等）
├── test/                       # 测试目录
│   ├── unit/                   # 单元测试
│   └── integration/            # 集成测试
├── docker/                     # Docker部署配置
│   ├── Dockerfile.dev          # 开发环境Dockerfile
│   └── Dockerfile.prod         # 生产环境Dockerfile
└── README.md
```

## 4. 核心设计详情

### 4.1 模块划分与职责

采用NestJS模块化架构，按业务功能划分核心模块，模块间通过依赖注入实现解耦：

| 模块名称                        | 核心职责                     | 核心功能                                            | 依赖模块                                   |
| ------------------------------- | ---------------------------- | --------------------------------------------------- | ------------------------------------------ |
| UserModule（用户模块）          | 用户信息管理、身份认证       | 登录、注册、用户查询/编辑、密码重置                 | DatabaseModule、JwtModule                  |
| CourseModule（课程模块）        | 课程全生命周期管理           | 课程创建、编辑、审核、查询、发布                    | UserModule、DatabaseModule                 |
| EnrollmentModule（选课模块）    | 选课/退课管理、冲突检测      | 选课提交、退课处理、冲突检测、选课名单管理          | UserModule、CourseModule、RedisModule      |
| GradeModule（成绩模块）         | 成绩录入、查询、统计         | 成绩录入/编辑、成绩查询、绩点计算、成绩单导出       | UserModule、CourseModule、EnrollmentModule |
| AnalyticsModule（统计分析模块） | 数据统计与报表生成           | 课程选课率分析、学生成绩统计、系统运营报表          | UserModule、CourseModule、GradeModule      |
| SystemModule（系统管理模块）    | 系统配置、权限管理、数据维护 | 角色权限配置、系统参数设置、数据备份/恢复、日志审计 | UserModule、DatabaseModule、RedisModule    |
| MessageModule（消息模块）       | 系统通知、消息发送           | 公告发布、私信发送、通知推送                        | UserModule、DatabaseModule、RedisModule    |

### 4.2 中间件设计

#### 4.2.1 核心中间件列表

| 中间件名称                               | 作用                             | 实现方式                                                                    |
| ---------------------------------------- | -------------------------------- | --------------------------------------------------------------------------- |
| AuthMiddleware（JWT认证中间件）          | 验证用户登录状态，解析JWT Token  | 基于`passport-jwt`，从请求头提取Token，验证有效性并挂载用户信息到`req.user` |
| PermissionMiddleware（权限控制中间件）   | 验证用户是否拥有模块/操作权限    | 基于用户角色与权限矩阵，校验请求路径对应的模块权限                          |
| ValidationMiddleware（请求验证中间件）   | 验证请求参数格式与合法性         | 集成Zod，对请求体/查询参数/路径参数进行Schema校验                           |
| LoggerMiddleware（日志中间件）           | 记录请求日志与响应日志           | 记录请求方法、路径、参数、响应状态码、耗时，输出到文件与控制台              |
| RateLimitMiddleware（限流中间件）        | 限制接口请求频率，防止高并发冲击 | 基于Redis实现滑动窗口限流，按用户ID/IP限制请求次数                          |
| ErrorHandlerMiddleware（错误处理中间件） | 统一异常捕获与格式化响应         | 捕获全局异常，转换为标准错误响应格式（包含错误码、消息、请求ID）            |

#### 4.2.2 中间件执行顺序

```Plain Text
请求进入 → LoggerMiddleware（记录请求） → AuthMiddleware（认证） → PermissionMiddleware（权限校验） → ValidationMiddleware（参数验证） → 控制器处理 → 响应 → LoggerMiddleware（记录响应）
```

### 4.3 接口设计规范（RPC）

统一入口 `POST /rpc`，请求/响应规范如下：

```ts
interface RpcRequest {
  id: string;
  method: string; // Domain.Action，如 Auth.Login
  params: Record<string, any>;
  meta?: { version?: string };
}

interface RpcResponse<T> {
  id: string;
  code: number; // 0 表示成功
  message: string;
  data: T;
  timestamp: number;
}
```

方法命名：`Auth.Login`、`Course.ListForStudent`、`Enrollment.Add`、`Admin.SetSelectTime` 等。

### 4.4 数据模型设计（Sequelize）

基于数据库文档的表结构，通过Sequelize定义数据模型，核心模型示例：

#### 4.4.1 UserModel（用户模型）

```TypeScript
import { Model, DataTypes } from 'sequelize';
import { sequelize } from '@/config/database.config';

export class UserModel extends Model {
  public id!: string; // UUID主键
  public username!: string; // 用户名/学号/工号
  public email!: string; // 邮箱
  public realName!: string; // 真实姓名
  public role!: 'STUDENT' | 'TEACHER' | 'ADMIN' | 'SUPER_ADMIN'; // 角色
  public departmentId!: string; // 所属院系ID
  public passwordHash!: string; // 密码哈希
  public status!: 'ACTIVE' | 'INACTIVE' | 'SUSPENDED' | 'GRADUATED'; // 账户状态
  // 其他字段...
}

UserModel.init(
  {
    id: {
      type: DataTypes.UUID,
      primaryKey: true,
      defaultValue: DataTypes.UUIDV4,
    },
    username: {
      type: DataTypes.STRING(50),
      unique: true,
      allowNull: false,
    },
    email: {
      type: DataTypes.STRING(100),
      unique: true,
      allowNull: false,
    },
    realName: {
      type: DataTypes.STRING(50),
      allowNull: false,
    },
    role: {
      type: DataTypes.ENUM('STUDENT', 'TEACHER', 'ADMIN', 'SUPER_ADMIN'),
      allowNull: false,
    },
    departmentId: {
      type: DataTypes.UUID,
      references: {
        model: 'departments',
        key: 'id',
      },
    },
    passwordHash: {
      type: DataTypes.STRING(255),
      allowNull: false,
    },
    status: {
      type: DataTypes.ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED', 'GRADUATED'),
      defaultValue: 'ACTIVE',
    },
    // 其他字段定义...
  },
  {
    sequelize,
    tableName: 'users',
    timestamps: true,
    underscored: true, // 字段名下划线命名
    createdAt: 'created_at',
    updatedAt: 'updated_at',
  }
);
```

#### 4.4.2 模型关联关系

| 模型            | 关联模型          | 关联类型 | 关联描述                                   |
| --------------- | ----------------- | -------- | ------------------------------------------ |
| UserModel       | DepartmentModel   | 多对一   | 一个院系包含多个用户，一个用户属于一个院系 |
| UserModel       | CourseModel       | 一对多   | 一个教师（用户角色）可创建多个课程         |
| UserModel       | EnrollmentModel   | 一对多   | 一个学生（用户角色）可选择多个课程         |
| CourseModel     | EnrollmentModel   | 一对多   | 一个课程可被多个学生选择                   |
| CourseModel     | PrerequisiteModel | 一对多   | 一个课程可关联多个先修课程                 |
| EnrollmentModel | GradeModel        | 一对一   | 一条选课记录对应一条成绩记录               |

### 4.5 权限控制设计

基于RBAC（基于角色的访问控制）模型，实现三级权限控制：

#### 4.5.1 权限层级

1. **系统级别权限**：控制是否能访问系统核心功能（如系统配置、权限管理）

2. **模块级别权限**：控制是否能访问某个业务模块（如课程模块、成绩模块）

3. **操作级别权限**：控制是否能执行模块内的具体操作（如创建、编辑、删除、审核、导出）

#### 4.5.2 权限校验流程

1. 用户登录后，后端返回其角色与权限矩阵（模块权限 + 操作权限）

2. 前端存储权限信息，动态渲染菜单；后端通过`PermissionMiddleware`校验接口权限

3. 权限校验逻辑：
   - 提取请求路径对应的模块代码（如`/api/courses`对应`course_management`模块）

   - 提取请求方法对应的操作权限（如POST对应`create`，PUT对应`edit`）

   - 校验当前用户角色是否拥有该模块的对应操作权限

   - 校验通过则允许继续处理，否则返回403无权限错误

### 4.6 缓存策略设计

基于Redis实现缓存，提升高并发场景下的接口响应速度：

#### 4.6.1 缓存场景与键命名规范

| 缓存场景     | 缓存键格式                                                         | 过期时间            | 缓存策略                       |
| ------------ | ------------------------------------------------------------------ | ------------------- | ------------------------------ |
| 用户权限缓存 | `auth:permission:{userId}`                                         | 10分钟              | LFU（最不经常使用）            |
| 课程列表缓存 | `course:list:{academicYear}:{semester}:{status}:{page}:{pageSize}` | 5分钟               | LRU（最近最少使用）            |
| 课程详情缓存 | `course:detail:{courseId}`                                         | 5分钟               | 主动更新（课程编辑时删除缓存） |
| 选课状态缓存 | `enrollment:status:{studentId}:{courseId}`                         | 30秒                | FIFO（先进先出）               |
| 热门课程缓存 | `course:popular:{academicYear}:{semester}`                         | 1小时               | 定时更新（每小时重新计算）     |
| 限流缓存     | `rate:limit:{endpoint}:{userId}`                                   | 窗口时间（如1分钟） | 滑动窗口                       |

#### 4.6.2 缓存更新策略

- **主动更新**：当缓存数据对应的源数据发生变更（如课程编辑、成绩更新）时，主动删除对应的缓存键

- **定时更新**：对于统计类数据（如热门课程、选课率），通过定时任务周期性更新缓存

- **过期淘汰**：设置合理的过期时间，缓存过期后自动从Redis淘汰，下次请求重新查询数据库并缓存

## 5. 部署与打包设计

仅数据库使用容器；后端以本机运行为主。

```bash
docker compose -f databases/docker-compose.db.yml up -d
pnpm run db:migrate && pnpm run db:seed
pnpm run build && pnpm run start
```

### 5.2 配置来源

- 后端所有配置统一从 `packages/config` 获取（端口、基础地址、RPC 路径、数据库连接参数）。
- 不使用根环境变量文件；如需动态配置由部署系统注入并同步到公共包。
  |MAX_REQUEST_PER_MINUTE|单用户每分钟最大请求数|60|

### 5.3 构建与启动脚本

#### 5.3.1 package.json脚本配置

```JSON
{
  "scripts": {
    "dev": "nodemon --exec ts-node src/main.ts", // 开发环境热更新
    "build": "esbuild src/main.ts --bundle --platform=node --target=node18 --outfile=dist/main.js", // 构建
    "start": "node dist/main.js", // 启动生产环境服务
    "migrate": "sequelize-cli db:migrate", // 执行数据库迁移
    "migrate:undo": "sequelize-cli db:migrate:undo", // 回滚数据库迁移
    "seed": "sequelize-cli db:seed:all", // 执行数据种子
    "test": "jest", // 运行测试
    "lint": "eslint . --ext .ts", // 代码检查
    "format": "prettier --write ." // 代码格式化
  }
}
```

#### 5.3.2 部署流程

1. 构建Docker镜像：`pnpm run build:backend && docker build -t course-select-backend:v1.0.0 -f docker/Dockerfile.prod .`

2. 启动服务：`docker-compose -f docker-compose.prod.yml up -d`

3. 执行数据库迁移：`docker exec -it course-select-backend-1 pnpm run migrate`

4. 查看日志：`docker logs -f course-select-backend-1`

5. 停止服务：`docker-compose -f docker-compose.prod.yml down`

## 6. 开发规范

### 6.1 代码规范

- 编程语言：TypeScript，严格模式（`strict: true`）

- 命名规范：
  - 文件名：kebab-case（如`user.controller.ts`）

  - 类名：PascalCase（如`UserController`）

  - 函数/变量名：camelCase（如`getUserById`）

  - 常量：UPPER_SNAKE_CASE（如`ERROR_CODE`）

- 代码风格：遵循ESLint + Prettier配置，禁止使用`any`类型，必须添加类型定义

- 注释规范：类、函数、复杂逻辑必须添加JSDoc注释，说明用途、参数、返回值

### 6.2 数据库操作规范

- 所有数据库操作必须通过Sequelize ORM实现，禁止直接执行SQL语句

- 复杂查询使用Sequelize的`findAll`+`where`+`include`实现，避免N+1查询问题

- 数据库事务：涉及多表操作的业务（如选课、成绩录入）必须使用事务，保证数据一致性

- 索引使用：查询频繁的字段必须添加索引，避免全表扫描

- 数据校验：数据库操作前必须通过Zod进行参数校验，防止无效数据入库

### 6.3 接口开发规范

- 接口路径：使用名词复数形式（如`/api/courses`而非`/api/course`）

- 请求方法：GET（查询）、POST（创建）、PUT（全量更新）、PATCH（部分更新）、DELETE（删除）

- 版本控制：如需接口版本迭代，通过URL路径实现（如`/api/v2/courses`）

- 错误处理：业务异常抛出`BusinessException`（包含错误码与消息），系统异常由全局过滤器捕获

- 安全性：敏感接口（如密码修改、数据删除）必须二次校验权限，重要操作记录审计日志

## 7. 交付物要求

- 后端项目目录结构完整，符合本文档定义

- 核心模块（用户、课程、选课、成绩）的控制器、服务、模型实现完成

- 所有中间件集成完毕，实现认证、权限、校验、日志功能

- 核心业务接口可正常响应，支持前端调用

- 数据库迁移脚本完整，可通过`pnpm run migrate`初始化表结构

- Docker镜像可正常构建与运行，支持集群部署

- 代码符合开发规范，无ESLint错误，核心功能包含单元测试

- 接口文档自动生成（基于Swagger），可访问`/api/docs`查看
