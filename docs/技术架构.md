# 项目技术架构文档

## 1. 项目概述

### 1.1 项目定位

本项目采用 monorepo 架构统一管理前端、后端子项目，核心为选课类业务系统，具备用户管理、课程选择、数据统计等核心功能，追求开发效率、可维护性和部署便捷性。

### 1.2 核心技术栈

| 维度     | 技术选型                                                             |
| -------- | -------------------------------------------------------------------- |
| 项目管理 | pnpm + monorepo                                                      |
| 前端     | vite + vue3 + ts + vue-router + pinia + scss + echarts + naive-ui    |
| 后端     | nest.js + ts + @nestjs/sequelize + sequelize-typescript + jwt + pino |
| 数据库   | PostgreSQL + Redis                                                   |
| 部署     | 仅数据库使用 Docker（PostgreSQL/Redis），前后端本机开发运行          |
| 接口规范 | RPC（统一入口 /rpc，方法分发）                                       |

## 2. 项目目录编排（Monorepo）

### 2.1 根目录结构

```Plain Text
course_schedule_system/
├── package.json
├── pnpm-workspace.yaml
├── tsconfig.json
├── .editorconfig
├── eslint.config.ts
├── .prettierrc
├── .gitignore
├── .nvmrc
├── apps/
├── packages/
├── docs/
└── README.md
```

#### 作用说明

- `apps/`：业务应用入口，包含前端与后端子项目；开发与运行的主要目录。
- `packages/`：公共包聚合，放置共享类型、运行时校验、数据库 schema、ORM 模型、通用工具等，供 `apps` 复用。
- 数据库容器编排已迁移至后端：`apps/backend/docker-compose.db.yml`；仅数据库使用容器，前后端本机运行。
- `docs/`：项目文档与技术设计说明，作为架构与实现的统一参考。
- 根工程文件（`pnpm-workspace.yaml`、TS/Lint/EditorConfig 等）：统一工程化配置，保障一致的构建与代码质量。

### 2.2 前端子项目（apps/frontend）

```Plain Text
apps/frontend/
├── package.json
├── tsconfig.json
├── vite.config.ts
├── index.html
├── public/
├── src/
│   ├── main.ts
│   ├── App.vue
│   ├── router/
│   ├── stores/
│   ├── api/
│   ├── components/
│   ├── pages/
│   ├── assets/
│   └── styles/
│       ├── _variables.scss
│       ├── _mixins.scss
│       ├── themes/
│       └── types/     # 将类型相关说明/约定集中到样式体系下
└── README.md
```

#### 作用说明

- `src/router/`：路由与守卫配置，管理页面访问与导航逻辑。
- `src/stores/`：Pinia 全局状态（用户、权限、系统配置、应用状态）。
- `src/api/`：HTTP 请求封装与模块化接口定义，统一拦截器与错误处理。
- `src/components/`、`src/pages/`：通用组件与业务页面，实现 UI 与交互。
- `src/styles/`：样式体系（变量、混合、主题）与类型约定聚合，统一视觉与约束。

### 2.3 后端子项目（apps/backend）

```Plain Text
apps/backend/
├── package.json
├── tsconfig.json
├── src/
│   ├── main.ts
│   ├── app.module.ts
│   ├── modules/
│   │   ├── user/
│   │   │   ├── user.module.ts
│   │   │   ├── user.controller.ts
│   │   │   └── user.service.ts
│   │   ├── course/
│   │   │   ├── course.module.ts
│   │   │   ├── course.controller.ts
│   │   │   └── course.service.ts
│   │   ├── enrollment/
│   │   │   ├── enrollment.module.ts
│   │   │   ├── enrollment.controller.ts
│   │   │   └── enrollment.service.ts
│   │   └── ...
│   ├── common/
│   │   ├── dto/
│   │   ├── guards/
│   │   ├── middleware/
│   │   ├── filters/
│   │   ├── config/
│   │   └── utils/
│   ├── models/
│   └── constants/
└── README.md
```

#### 作用说明

- `src/modules/*`：按功能模块分目录，每个模块自包含 `module/controller/service`，提升内聚与可维护性。
- `src/common/`：跨模块复用的 `dto/guards/middleware/filters/config/utils`，统一验证、鉴权、异常与配置。
- `src/models/`：Sequelize ORM 模型定义与关联，承载持久层结构。
- 迁移与种子：统一位于后端（`apps/backend/src/db/migrations` 与 Nest 种子服务），通过后端命令执行；不再使用独立 `databases/` 目录。

### 2.4 目录架构（规划总览）

```Plain Text
packages/
├── shared-types/
├── runtime-validation/
├── db-schema/
├── models/
├── utils/
└── config/

`apps/backend`
├── docker-compose.db.yml
└── src/db/scripts/
    ├── init_macos.sh
    └── init_linux.sh

docs/
├── 技术架构.md
├── 接口文档.md
├── 研究生排课系统前端文档.md
├── 研究生排课系统后端文档 .md
├── 研究生排课系统的业务文档.md
└── 研究生排课系统的数据库脚本.md
```

#### 作用说明

- `packages/shared-types`：前后端共享 TS 类型与接口契约。
- `packages/runtime-validation`：运行时类型校验（如 zod），保证接口入参/出参安全。
- `packages/db-schema`：数据库 schema 与迁移描述，统一结构来源。
- `packages/models`：共享 ORM 模型与实体关系定义，供后端装配。
- `packages/utils`：通用工具（日期、加密、日志等）。
- `packages/config`：统一的公共配置（端口、基础地址、RPC 路径、数据库连接参数），供前后端与脚手架引用。
  - `apps/backend/docker-compose.db.yml` 与 `src/db/scripts`：仅数据库容器与一键初始化脚本；迁移与种子由后端统一命令执行。

## 3. 数据链路设计

### 3.1 核心数据链路流程图

```mermaid
graph LR
    A[前端页面] --> B[前端API请求]
    B --> C[NestJS控制器]
    C --> D[权限校验Guard]
    D --> E[业务Service]
    E --> F{缓存判断}
    F -- 有缓存 --> G[Redis缓存]
    F -- 无缓存 --> H[Sequelize]
    H --> I[PostgreSQL]
    I --> J[数据返回Service]
    G --> J
    J --> K[响应格式化Interceptor]
    K --> L[前端Stores]
    L --> M[前端页面渲染]
```

### 3.2 关键链路说明

1. **前端请求链路**：用户操作触发页面事件 → 调用 api 模块封装的请求 → 携带 token 请求后端接口。

2. **后端处理链路**：
   - 控制器接收请求 → Guard 校验 JWT 权限 → 调用对应 Service 处理业务逻辑；

   - Service 优先查询 Redis 缓存，命中则直接返回，未命中则通过 Sequelize 操作 PostgreSQL；

   - 数据库返回数据后，Service 将数据写入 Redis 缓存（设置过期时间） → 拦截器格式化响应 → 返回前端。

3. **前端渲染链路**：前端接收响应 → 写入 Pinia Stores → 页面监听 Stores 数据变化 → 重新渲染页面。

## 4. 数据库设计核心规则

### 4.1 数据库选型说明

- **核心数据库**：PostgreSQL（选课业务以结构化数据为主，如用户、课程、选课记录，SQL 数据库的事务、关联查询更适配，且 Sequelize 对 PostgreSQL 支持完善）；

- **缓存数据库**：Redis（仅用于热点数据缓存，如课程列表、用户信息，设置合理过期时间避免缓存雪崩）；

- **暂不使用**：MongoDB（非结构化数据少，无需引入）、Neo4j（选课场景无复杂图关系，引入会增加复杂度）。

### 4.2 数据库交互规则

1. 所有数据库操作通过 Sequelize ORM 封装，避免直接写 SQL，提升可维护性；

2. 核心业务（选课/退课）开启数据库事务，保证数据一致性；

3. 热点数据（如课程列表）缓存有效期设置为 10 分钟，用户信息缓存与 JWT 过期时间一致；

4. 数据库迁移通过 Sequelize Migrations 管理，避免手动修改表结构。

## 5. 部署与打包设计

### 5.1 打包流程

1. **前端打包**：`pnpm run build`（vite 打包，输出 dist 目录）；

2. **后端打包**：`pnpm run build`（tsc 编译 TS，输出 dist 目录；生产启动使用 `node dist/main.js`）。

### 5.2 数据库容器与迁移

- 仅数据库层使用 Docker：通过 `apps/backend/docker-compose.db.yml` 启动 PostgreSQL/Redis，用于迁移与种子数据注入。
- 前端/后端仅开发环境运行：不配置容器，使用本机 Node.js 与 pnpm 开发。
- 常用命令：

  ```bash
  # 启动数据库容器
  docker compose -f apps/backend/docker-compose.db.yml up -d postgres redis

  # 执行迁移与种子（后端统一命令）
  pnpm -F @apps/backend migrate:dev
  pnpm -F @apps/backend seed:dev
  ```

## 6. 接口设计核心规则（RPC）

### 6.1 RPC 规范

- 统一入口：`POST /rpc`
- 请求包：

  ```json
  {
    "id": "<uuid>",
    "method": "Service.Method",
    "params": {
      /* 参数 */
    },
    "meta": { "version": "v1" }
  }
  ```

- 响应包：

  ```json
  {
    "id": "<uuid>",
    "code": 0,
    "message": "OK",
    "data": {
      /* 返回数据 */
    },
    "timestamp": 1730000000000
  }
  ```

- 方法命名：`Auth.Login`、`Course.List`、`Enrollment.Add`、`Admin.SetSelectTime` 等；按领域聚合。
- 错误码与重试：沿用统一错误码，客户端可据 `code` 判定重试/降级。

### 6.2 中间件设计

- 跨域中间件：允许前端域名跨域请求；

- 日志中间件：记录所有请求的 URL、参数、响应时间；

- 异常中间件：统一捕获后端异常，返回标准化错误响应。

---

### 总结

1. 项目基于**pnpm + monorepo** 拆分前端（apps/frontend）和后端（apps/backend）子项目，目录结构按业务模块拆分，符合可维护性原则；

2. 数据链路核心为「前端请求 → 后端权限校验 → 缓存优先 → 数据库操作 → 响应渲染」，优先使用 PostgreSQL（结构化数据适配）+ Redis（缓存）；

3. 部署与运行遵循“数据库用容器、应用用本机”的原则：数据库通过容器完成迁移与初始化；前后端在开发环境以本机运行，避免不必要的容器复杂度。

## 7. 工程化与开发规范（新增）

### 7.1 配置来源

- 全部配置统一来源 `packages/config`，包括前后端端口、基础地址、RPC 路径与数据库连接参数。
- 不再使用根环境变量文件；如需环境变量将单独约定并由部署注入。

### 7.2 代码质量

- ESLint 9（Flat 配置） + Prettier（半角分号、单引号、printWidth 100）统一 JS/TS/Vue 代码风格。
- Stylelint 标准集（含 SCSS/Vue 支持）统一样式规范。
- 提交前：Husky + lint-staged 自动执行增量修复与检查。

### 7.3 脚本约定

- 优先使用 `pnpm -F <workspace>` 运行分项目命令（如 `pnpm -F @apps/frontend dev`、`pnpm -F @apps/backend dev`）。

### 7.4 路径别名与工作区依赖（新增）

- 前端路径别名：在 `apps/frontend/tsconfig.json` 增加 `paths` 与 `types: ['vite/client']`，在 `vite.config.ts` 配置 `resolve.alias`，统一使用 `@` 别名（如 `@api`、`@stores`、`@router`、`@layouts`、`@styles`）。
- 工作区依赖：前端通过 `package.json` 直接依赖工作区包（`@packages/config`、`@packages/shared-types`），使用包名导入而非自定义 alias。
- 角色默认页：登录后按角色跳转默认页；无统一 dashboard，但使用统一布局与守卫。

### 7.5 权限类型统一（新增）

- 统一权限与菜单类型由 `packages/shared-types` 提供：
  - `PermissionData`：包含 `modules/flags/data_scopes`；其中 `modules` 为模块权限矩阵（`accessible` 与 `operations`）。
  - `MenuData`：`navigation/sidebar/shortcuts` 菜单集合，元素为 `MenuItem`（含 `code/name/path/icon/order/children/operations`）。
- 后端 `Auth.GetPermissions` 返回结构对齐上述类型，前端按照 `meta.moduleCode/operation` 与 `PermissionData.modules` 校验路由访问。

### 7.6 前端 UI 与主题（新增）

- UI 组件统一采用 Naive UI：按钮（NButton）、菜单（NMenu）、面包屑（NBreadcrumb）、分页（NDataTable+NPagination）、对话框与消息（NDialogProvider/NMessageProvider）、日期时间（NDateTimePicker）。
- 主题策略：默认“跟随系统”（auto），Header 使用 NSwitch 双态展示当前浅/深状态；NConfigProvider 根据 app.store.isDark 应用 darkTheme。
- 侧边栏图标映射：菜单 icon 字段按映射表转换（settings、people、check、checklist、calendar、book、edit_note、user）。后端 icon 不规范或为空：不显示图标，文本标记为 error，用于后续统一枚举。

### 7.7 路由与页面结构（新增）

- 页面自包含：每个页面目录包含 route.ts 与 index.vue、config/、components/；通过 `import.meta.glob('@/pages/**/route.ts')` 动态收集。
- 公共路由（如 /login）不纳入布局 children，鉴权路由由守卫按 `meta.requiresAuth` 与权限模块控制。

### 7.8 后端运行与跨域（新增）

- 开发运行采用 tsx + ESModule（`package.json` 设置 `type: module`，`tsconfig.json` 设置 `module: ESNext`）。
- 入口启用 CORS，允许前端 dev 地址访问（`origin=devConfig.frontend.baseUrl`）。

### 7.9 初始化脚本（补充）

- `init_macos.sh` 与 `init_linux.sh` 直接调用后端统一命令（迁移、状态、最小种子、批量假数据、校验）；`docker-compose` 的 `version` 字段废弃提示。
