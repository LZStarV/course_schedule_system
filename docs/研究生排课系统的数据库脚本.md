# Sequelize CLI 数据库迁移脚本配置

## 项目结构

```
course_schedule_system/
├── apps/
│   ├── backend/
│   └── frontend/
├── databases/
│   ├── migrations/          # 迁移脚本（统一管理）
│   ├── seeders/             # 种子数据（统一管理）
│   ├── init-scripts/        # 初始化 SQL/脚本
│   ├── scripts/             # 数据库相关 Shell 脚本
│   └── docker-compose.db.yml# 仅数据库容器编排
├── packages/
├── docs/
├── .sequelizerc             # Sequelize CLI 路径统一到 databases
└── pnpm-workspace.yaml
```

## 1. 配置文件

### 1.1 Sequelize CLI 配置文件 (`.sequelizerc`)

```javascript
const path = require('path');

module.exports = {
  config: path.resolve(
    'apps/backend/src/config',
    'database.ts'
  ),
  'models-path': path.resolve('apps/backend/src', 'models'),
  'seeders-path': path.resolve('databases', 'seeders'),
  'migrations-path': path.resolve(
    'databases',
    'migrations'
  ),
};
```

### 1.2 TypeScript 数据库配置 (`src/config/database.ts`)

```typescript
import { SequelizeOptions } from 'sequelize-typescript';
import path from 'path';
import { devConfig } from '@packages/config';

interface DatabaseConfig {
  development: SequelizeOptions;
  test: SequelizeOptions;
  production: SequelizeOptions;
}

const config: DatabaseConfig = {
  development: {
    username: (devConfig as any).database.user,
    password: (devConfig as any).database.password,
    database: (devConfig as any).database.name,
    host: (devConfig as any).database.host,
    port: (devConfig as any).database.port,
    dialect: 'postgres',
    dialectOptions: {
      ssl: (devConfig as any).database.ssl || false,
    },
    logging: (devConfig as any).database.logging
      ? console.log
      : false,
    define: {
      timestamps: true,
      underscored: true,
      freezeTableName: true,
      charset: 'utf8mb4',
    },
    timezone: '+08:00', // 中国时区
    pool: {
      max: 20,
      min: 5,
      acquire: 30000,
      idle: 10000,
    },
    models: [path.join(__dirname, '../models/**/*.ts')],
  },

  test: {
    username: process.env.DB_TEST_USER || 'course_test',
    password:
      process.env.DB_TEST_PASSWORD || 'test_password',
    database:
      process.env.DB_TEST_NAME || 'course_select_test',
    host: process.env.DB_TEST_HOST || 'localhost',
    port: parseInt(process.env.DB_TEST_PORT || '5433'),
    dialect: 'postgres',
    logging: false,
    define: {
      timestamps: true,
      underscored: true,
      freezeTableName: true,
    },
  },

  production: {
    username: process.env.DB_PROD_USER,
    password: process.env.DB_PROD_PASSWORD,
    database: process.env.DB_PROD_NAME,
    host: process.env.DB_PROD_HOST,
    port: parseInt(process.env.DB_PROD_PORT || '5432'),
    dialect: 'postgres',
    dialectOptions: {
      ssl: {
        require: true,
        rejectUnauthorized: false,
      },
    },
    logging: false,
    define: {
      timestamps: true,
      underscored: true,
      freezeTableName: true,
    },
    pool: {
      max: 50,
      min: 10,
      acquire: 30000,
      idle: 10000,
    },
    replication: process.env.DB_READ_HOST
      ? {
          write: {
            host: process.env.DB_PROD_HOST,
            username: process.env.DB_PROD_USER,
            password: process.env.DB_PROD_PASSWORD,
          },
          read: [
            {
              host: process.env.DB_READ_HOST,
              username: process.env.DB_READ_USER,
              password: process.env.DB_READ_PASSWORD,
            },
          ],
        }
      : undefined,
  },
};

export default config;
```

### 1.3 环境变量示例 (`.env`)

```bash
# Database Configuration
DB_USER=course_admin
DB_PASSWORD=your_secure_password
DB_NAME=course_select
DB_HOST=localhost
DB_PORT=5432
DB_SSL=false
DB_LOGGING=true

# Test Database
DB_TEST_USER=course_test
DB_TEST_PASSWORD=test_password
DB_TEST_NAME=course_select_test
DB_TEST_HOST=localhost
DB_TEST_PORT=5433

# Production Database
DB_PROD_USER=course_prod
DB_PROD_PASSWORD=prod_secure_password
DB_PROD_NAME=course_select_prod
DB_PROD_HOST=postgres-master
DB_PROD_PORT=5432

# Read Replica (Optional)
DB_READ_HOST=postgres-replica
DB_READ_USER=course_prod
DB_READ_PASSWORD=prod_secure_password

# Redis Configuration
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password
REDIS_DB=0

# JWT Configuration
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=2h
JWT_REFRESH_SECRET=your_refresh_secret
JWT_REFRESH_EXPIRES_IN=7d

# Application
NODE_ENV=development
API_PORT=3000
API_HOST=0.0.0.0
CORS_ORIGIN=http://localhost:5173

# File Upload
MAX_FILE_SIZE=50MB
ALLOWED_FILE_TYPES=image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document
UPLOAD_DIR=./uploads

# Email (Optional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASSWORD=your_app_password
SMTP_FROM=noreply@course-select.edu
```

## 2. 模型定义 (Models)

### 2.1 模型索引文件 (`src/models/index.ts`)

```typescript
import {
  Sequelize,
  DataTypes,
  ModelAttributes,
  ModelOptions,
} from 'sequelize';
import config from '../config/database';
import fs from 'fs';
import path from 'path';

// 动态加载所有模型
const loadModels = (sequelize: Sequelize) => {
  const modelsDir = __dirname;
  const models: { [key: string]: any } = {};

  // 读取所有模型文件
  fs.readdirSync(modelsDir)
    .filter(file => {
      return (
        file.indexOf('.') !== 0 &&
        file !== 'index.ts' &&
        file.slice(-3) === '.ts' &&
        !file.includes('.test.ts') &&
        !file.includes('.spec.ts')
      );
    })
    .forEach(file => {
      const modelPath = path.join(modelsDir, file);
      const modelModule = require(modelPath);

      // 假设每个模型文件默认导出模型类
      const model = modelModule.default(
        sequelize,
        DataTypes
      );
      models[model.name] = model;
    });

  // 关联模型
  Object.keys(models).forEach(modelName => {
    if (models[modelName].associate) {
      models[modelName].associate(models);
    }
  });

  return models;
};

// 创建 Sequelize 实例
const env = process.env.NODE_ENV || 'development';
const sequelizeConfig = (config as any)[env];
const sequelize = new Sequelize(sequelizeConfig);

// 加载模型
const models = loadModels(sequelize);

// 导出模型和 Sequelize 实例
export { sequelize, Sequelize, DataTypes };
export default models;
```

### 2.2 用户模型 (`src/models/user.model.ts`)

```typescript
import {
  DataTypes,
  Model,
  Optional,
  Sequelize,
} from 'sequelize';

// 用户角色枚举
export enum UserRole {
  STUDENT = 'STUDENT',
  TEACHER = 'TEACHER',
  ADMIN = 'ADMIN',
  SUPER_ADMIN = 'SUPER_ADMIN',
}

// 用户状态枚举
export enum UserStatus {
  ACTIVE = 'ACTIVE',
  INACTIVE = 'INACTIVE',
  SUSPENDED = 'SUSPENDED',
  GRADUATED = 'GRADUATED',
}

// 用户性别枚举
export enum Gender {
  MALE = 'MALE',
  FEMALE = 'FEMALE',
  OTHER = 'OTHER',
  SECRET = 'SECRET',
}

// 用户属性接口
export interface UserAttributes {
  id: string;
  username: string;
  email: string;
  phone?: string;
  real_name: string;
  avatar_url?: string;
  gender: Gender;
  birth_date?: Date;
  student_id?: string;
  teacher_id?: string;
  department_id?: string;
  major?: string;
  grade?: number;
  class_name?: string;
  password_hash: string;
  role: UserRole;
  status: UserStatus;
  last_login_at?: Date;
  failed_login_attempts: number;
  locked_until?: Date;
  created_by?: string;
  updated_by?: string;
  created_at: Date;
  updated_at: Date;
}

// 创建时可选属性
export interface UserCreationAttributes extends Optional<
  UserAttributes,
  | 'id'
  | 'failed_login_attempts'
  | 'status'
  | 'created_at'
  | 'updated_at'
> {}

// 用户模型类
export default function UserModel(sequelize: Sequelize) {
  class User
    extends Model<UserAttributes, UserCreationAttributes>
    implements UserAttributes
  {
    public id!: string;
    public username!: string;
    public email!: string;
    public phone?: string;
    public real_name!: string;
    public avatar_url?: string;
    public gender!: Gender;
    public birth_date?: Date;
    public student_id?: string;
    public teacher_id?: string;
    public department_id?: string;
    public major?: string;
    public grade?: number;
    public class_name?: string;
    public password_hash!: string;
    public role!: UserRole;
    public status!: UserStatus;
    public last_login_at?: Date;
    public failed_login_attempts!: number;
    public locked_until?: Date;
    public created_by?: string;
    public updated_by?: string;
    public readonly created_at!: Date;
    public readonly updated_at!: Date;

    // 关联方法
    static associate(models: any) {
      User.belongsTo(models.User, {
        as: 'creator',
        foreignKey: 'created_by',
      });
      User.belongsTo(models.User, {
        as: 'updater',
        foreignKey: 'updated_by',
      });
      User.belongsTo(models.Department, {
        foreignKey: 'department_id',
        as: 'department',
      });
      User.hasOne(models.UserProfile, {
        foreignKey: 'user_id',
        as: 'profile',
      });
      User.hasMany(models.Course, {
        foreignKey: 'teacher_id',
        as: 'courses',
      });
      User.hasMany(models.Enrollment, {
        foreignKey: 'student_id',
        as: 'enrollments',
      });
      User.hasMany(models.Notification, {
        foreignKey: 'recipient_id',
        as: 'notifications',
      });
    }
  }

  User.init(
    {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        comment: '用户唯一标识',
      },
      username: {
        type: DataTypes.STRING(50),
        allowNull: false,
        unique: true,
        validate: {
          len: [3, 50],
          is: /^[a-zA-Z0-9_\-\.]+$/i,
        },
        comment: '用户名/学号/工号',
      },
      email: {
        type: DataTypes.STRING(100),
        allowNull: false,
        unique: true,
        validate: {
          isEmail: true,
        },
        comment: '邮箱地址',
      },
      phone: {
        type: DataTypes.STRING(20),
        validate: {
          is: /^[0-9\+\-\(\)\s]+$/i,
        },
        comment: '手机号码',
      },
      real_name: {
        type: DataTypes.STRING(50),
        allowNull: false,
        validate: {
          notEmpty: true,
        },
        comment: '真实姓名',
      },
      avatar_url: {
        type: DataTypes.STRING(500),
        validate: {
          isUrl: true,
        },
        comment: '头像URL',
      },
      gender: {
        type: DataTypes.ENUM(...Object.values(Gender)),
        allowNull: false,
        defaultValue: Gender.SECRET,
        comment: '性别',
      },
      birth_date: {
        type: DataTypes.DATEONLY,
        validate: {
          isDate: true,
          isBefore: new Date().toISOString(),
        },
        comment: '出生日期',
      },
      student_id: {
        type: DataTypes.STRING(20),
        unique: true,
        comment: '学号（学生专用）',
      },
      teacher_id: {
        type: DataTypes.STRING(20),
        unique: true,
        comment: '工号（教师专用）',
      },
      department_id: {
        type: DataTypes.UUID,
        comment: '所属院系ID',
      },
      major: {
        type: DataTypes.STRING(100),
        comment: '专业（学生）',
      },
      grade: {
        type: DataTypes.INTEGER,
        validate: {
          min: 1,
          max: 8,
        },
        comment: '年级',
      },
      class_name: {
        type: DataTypes.STRING(50),
        comment: '班级名称',
      },
      password_hash: {
        type: DataTypes.STRING(255),
        allowNull: false,
        comment: '密码哈希值',
      },
      role: {
        type: DataTypes.ENUM(...Object.values(UserRole)),
        allowNull: false,
        validate: {
          isIn: [Object.values(UserRole)],
        },
        comment: '用户角色',
      },
      status: {
        type: DataTypes.ENUM(...Object.values(UserStatus)),
        allowNull: false,
        defaultValue: UserStatus.ACTIVE,
        comment: '账户状态',
      },
      last_login_at: {
        type: DataTypes.DATE,
        comment: '最后登录时间',
      },
      failed_login_attempts: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
        validate: {
          min: 0,
        },
        comment: '登录失败次数',
      },
      locked_until: {
        type: DataTypes.DATE,
        comment: '账户锁定直到',
      },
      created_by: {
        type: DataTypes.UUID,
        comment: '创建者ID',
      },
      updated_by: {
        type: DataTypes.UUID,
        comment: '更新者ID',
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '创建时间',
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '更新时间',
      },
    } as ModelAttributes<User, UserAttributes>,
    {
      sequelize,
      modelName: 'User',
      tableName: 'users',
      underscored: true,
      timestamps: true,
      paranoid: false,
      indexes: [
        {
          unique: true,
          fields: ['username'],
          name: 'users_username_unique',
        },
        {
          unique: true,
          fields: ['email'],
          name: 'users_email_unique',
        },
        {
          unique: true,
          fields: ['student_id'],
          name: 'users_student_id_unique',
          where: {
            student_id: {
              [DataTypes.Op.ne]: null,
            },
          },
        },
        {
          unique: true,
          fields: ['teacher_id'],
          name: 'users_teacher_id_unique',
          where: {
            teacher_id: {
              [DataTypes.Op.ne]: null,
            },
          },
        },
        {
          fields: ['department_id'],
          name: 'users_department_id_idx',
        },
        {
          fields: ['role', 'status'],
          name: 'users_role_status_idx',
        },
        {
          fields: ['created_at'],
          name: 'users_created_at_idx',
        },
        {
          fields: ['real_name'],
          name: 'users_real_name_trgm_idx',
          using: 'gin',
          operator: 'gin_trgm_ops',
        },
      ],
      hooks: {
        beforeValidate: (user: User) => {
          // 确保学号和工号在对应角色中唯一
          if (user.role === UserRole.STUDENT) {
            user.teacher_id = null;
          } else if (user.role === UserRole.TEACHER) {
            user.student_id = null;
          }
        },
      },
    } as ModelOptions
  );

  return User;
}
```

### 2.3 用户资料模型 (`src/models/user-profile.model.ts`)

```typescript
import {
  DataTypes,
  Model,
  Optional,
  Sequelize,
} from 'sequelize';

export interface UserProfileAttributes {
  id: string;
  user_id: string;
  education_background?: any; // JSONB
  bio?: string;
  research_interests?: string[];
  office_location?: string;
  office_hours?: string;
  social_links?: any; // JSONB
  preferences?: any; // JSONB
  total_credits: number;
  gpa?: number;
  created_at: Date;
  updated_at: Date;
}

export interface UserProfileCreationAttributes extends Optional<
  UserProfileAttributes,
  'id' | 'total_credits' | 'created_at' | 'updated_at'
> {}

export default function UserProfileModel(
  sequelize: Sequelize
) {
  class UserProfile
    extends Model<
      UserProfileAttributes,
      UserProfileCreationAttributes
    >
    implements UserProfileAttributes
  {
    public id!: string;
    public user_id!: string;
    public education_background?: any;
    public bio?: string;
    public research_interests?: string[];
    public office_location?: string;
    public office_hours?: string;
    public social_links?: any;
    public preferences!: any;
    public total_credits!: number;
    public gpa?: number;
    public readonly created_at!: Date;
    public readonly updated_at!: Date;

    static associate(models: any) {
      UserProfile.belongsTo(models.User, {
        foreignKey: 'user_id',
        as: 'user',
      });
    }
  }

  UserProfile.init(
    {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        comment: '资料ID',
      },
      user_id: {
        type: DataTypes.UUID,
        allowNull: false,
        unique: true,
        comment: '用户ID',
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      education_background: {
        type: DataTypes.JSONB,
        defaultValue: [],
        comment: '教育背景',
      },
      bio: {
        type: DataTypes.TEXT,
        comment: '个人简介',
      },
      research_interests: {
        type: DataTypes.ARRAY(DataTypes.STRING),
        defaultValue: [],
        comment: '研究方向',
      },
      office_location: {
        type: DataTypes.STRING(100),
        comment: '办公室位置',
      },
      office_hours: {
        type: DataTypes.TEXT,
        comment: '办公时间',
      },
      social_links: {
        type: DataTypes.JSONB,
        defaultValue: {},
        comment: '社交媒体链接',
      },
      preferences: {
        type: DataTypes.JSONB,
        defaultValue: {
          notification: {
            email: true,
            sms: false,
            push: true,
          },
          theme: 'light',
          language: 'zh-CN',
        },
        comment: '用户偏好设置',
      },
      total_credits: {
        type: DataTypes.DECIMAL(5, 1),
        allowNull: false,
        defaultValue: 0,
        validate: {
          min: 0,
        },
        comment: '已修总学分',
      },
      gpa: {
        type: DataTypes.DECIMAL(3, 2),
        validate: {
          min: 0,
          max: 5,
        },
        comment: '平均绩点',
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '创建时间',
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '更新时间',
      },
    },
    {
      sequelize,
      modelName: 'UserProfile',
      tableName: 'user_profiles',
      underscored: true,
      timestamps: true,
      indexes: [
        {
          unique: true,
          fields: ['user_id'],
          name: 'user_profiles_user_id_unique',
        },
      ],
    }
  );

  return UserProfile;
}
```

### 2.4 院系模型 (`src/models/department.model.ts`)

```typescript
import {
  DataTypes,
  Model,
  Optional,
  Sequelize,
} from 'sequelize';

export enum DepartmentStatus {
  ACTIVE = 'ACTIVE',
  INACTIVE = 'INACTIVE',
}

export interface DepartmentAttributes {
  id: string;
  code: string;
  name: string;
  full_name?: string;
  description?: string;
  parent_id?: string;
  level: number;
  path?: string;
  contact_person?: string;
  contact_phone?: string;
  contact_email?: string;
  location?: string;
  status: DepartmentStatus;
  display_order: number;
  created_by?: string;
  updated_by?: string;
  created_at: Date;
  updated_at: Date;
}

export interface DepartmentCreationAttributes extends Optional<
  DepartmentAttributes,
  | 'id'
  | 'level'
  | 'status'
  | 'display_order'
  | 'created_at'
  | 'updated_at'
> {}

export default function DepartmentModel(
  sequelize: Sequelize
) {
  class Department
    extends Model<
      DepartmentAttributes,
      DepartmentCreationAttributes
    >
    implements DepartmentAttributes
  {
    public id!: string;
    public code!: string;
    public name!: string;
    public full_name?: string;
    public description?: string;
    public parent_id?: string;
    public level!: number;
    public path?: string;
    public contact_person?: string;
    public contact_phone?: string;
    public contact_email?: string;
    public location?: string;
    public status!: DepartmentStatus;
    public display_order!: number;
    public created_by?: string;
    public updated_by?: string;
    public readonly created_at!: Date;
    public readonly updated_at!: Date;

    static associate(models: any) {
      Department.belongsTo(models.Department, {
        as: 'parent',
        foreignKey: 'parent_id',
        constraints: false,
      });
      Department.hasMany(models.Department, {
        as: 'children',
        foreignKey: 'parent_id',
        constraints: false,
      });
      Department.hasMany(models.User, {
        foreignKey: 'department_id',
        as: 'users',
      });
      Department.hasMany(models.Course, {
        foreignKey: 'department_id',
        as: 'courses',
      });
      Department.belongsTo(models.User, {
        as: 'creator',
        foreignKey: 'created_by',
      });
      Department.belongsTo(models.User, {
        as: 'updater',
        foreignKey: 'updated_by',
      });
    }
  }

  Department.init(
    {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        comment: '院系ID',
      },
      code: {
        type: DataTypes.STRING(20),
        allowNull: false,
        unique: true,
        validate: {
          notEmpty: true,
        },
        comment: '院系代码',
      },
      name: {
        type: DataTypes.STRING(100),
        allowNull: false,
        validate: {
          notEmpty: true,
        },
        comment: '院系名称',
      },
      full_name: {
        type: DataTypes.STRING(200),
        comment: '完整名称',
      },
      description: {
        type: DataTypes.TEXT,
        comment: '描述',
      },
      parent_id: {
        type: DataTypes.UUID,
        comment: '上级院系ID',
      },
      level: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 1,
        validate: {
          min: 1,
        },
        comment: '层级深度',
      },
      path: {
        type: DataTypes.STRING(500),
        comment: '路径（用于快速查询子部门）',
      },
      contact_person: {
        type: DataTypes.STRING(50),
        comment: '联系人',
      },
      contact_phone: {
        type: DataTypes.STRING(20),
        comment: '联系电话',
      },
      contact_email: {
        type: DataTypes.STRING(100),
        validate: {
          isEmail: true,
        },
        comment: '联系邮箱',
      },
      location: {
        type: DataTypes.STRING(200),
        comment: '地址',
      },
      status: {
        type: DataTypes.ENUM(
          ...Object.values(DepartmentStatus)
        ),
        allowNull: false,
        defaultValue: DepartmentStatus.ACTIVE,
        comment: '状态',
      },
      display_order: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
        comment: '显示顺序',
      },
      created_by: {
        type: DataTypes.UUID,
        comment: '创建者ID',
      },
      updated_by: {
        type: DataTypes.UUID,
        comment: '更新者ID',
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '创建时间',
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '更新时间',
      },
    },
    {
      sequelize,
      modelName: 'Department',
      tableName: 'departments',
      underscored: true,
      timestamps: true,
      indexes: [
        {
          unique: true,
          fields: ['code'],
          name: 'departments_code_unique',
        },
        {
          fields: ['parent_id'],
          name: 'departments_parent_id_idx',
        },
        {
          fields: ['path'],
          name: 'departments_path_idx',
        },
        {
          fields: ['status'],
          name: 'departments_status_idx',
        },
      ],
    }
  );

  return Department;
}
```

### 2.5 课程模型 (`src/models/course.model.ts`)

```typescript
import {
  DataTypes,
  Model,
  Optional,
  Sequelize,
} from 'sequelize';

export enum CourseType {
  COMPULSORY = 'COMPULSORY',
  ELECTIVE = 'ELECTIVE',
  GENERAL = 'GENERAL',
  EXPERIMENTAL = 'EXPERIMENTAL',
  PRACTICE = 'PRACTICE',
}

export enum CourseStatus {
  DRAFT = 'DRAFT',
  PENDING_REVIEW = 'PENDING_REVIEW',
  REJECTED = 'REJECTED',
  PUBLISHED = 'PUBLISHED',
  SELECTING = 'SELECTING',
  SELECTION_ENDED = 'SELECTION_ENDED',
  IN_PROGRESS = 'IN_PROGRESS',
  ENDED = 'ENDED',
  ARCHIVED = 'ARCHIVED',
}

export enum Semester {
  FALL = 'FALL',
  SPRING = 'SPRING',
  SUMMER = 'SUMMER',
  WINTER = 'WINTER',
}

export enum LocationType {
  CLASSROOM = 'CLASSROOM',
  LAB = 'LAB',
  ONLINE = 'ONLINE',
  MIXED = 'MIXED',
}

export interface CourseAttributes {
  id: string;
  course_code: string;
  course_number?: string;
  name: string;
  english_name?: string;
  credit: number;
  credit_hours: number;
  course_type: CourseType;
  department_id: string;
  teacher_id: string;
  academic_year: string;
  semester: Semester;
  capacity: number;
  min_quota: number;
  enrolled_count: number;
  status: CourseStatus;
  schedule: any; // JSONB
  location_type: LocationType;
  location_details?: any; // JSONB
  description?: string;
  objectives?: string;
  syllabus?: string;
  assessment_method?: string;
  textbook_reference?: string;
  attachments?: any; // JSONB
  restrictions?: any; // JSONB
  view_count: number;
  favorite_count: number;
  review_notes?: string;
  reviewed_at?: Date;
  reviewed_by?: string;
  published_at?: Date;
  created_at: Date;
  updated_at: Date;
}

export interface CourseCreationAttributes extends Optional<
  CourseAttributes,
  | 'id'
  | 'enrolled_count'
  | 'status'
  | 'view_count'
  | 'favorite_count'
  | 'min_quota'
  | 'location_type'
  | 'created_at'
  | 'updated_at'
> {}

export default function CourseModel(sequelize: Sequelize) {
  class Course
    extends Model<
      CourseAttributes,
      CourseCreationAttributes
    >
    implements CourseAttributes
  {
    public id!: string;
    public course_code!: string;
    public course_number?: string;
    public name!: string;
    public english_name?: string;
    public credit!: number;
    public credit_hours!: number;
    public course_type!: CourseType;
    public department_id!: string;
    public teacher_id!: string;
    public academic_year!: string;
    public semester!: Semester;
    public capacity!: number;
    public min_quota!: number;
    public enrolled_count!: number;
    public status!: CourseStatus;
    public schedule!: any;
    public location_type!: LocationType;
    public location_details?: any;
    public description?: string;
    public objectives?: string;
    public syllabus?: string;
    public assessment_method?: string;
    public textbook_reference?: string;
    public attachments?: any;
    public restrictions?: any;
    public view_count!: number;
    public favorite_count!: number;
    public review_notes?: string;
    public reviewed_at?: Date;
    public reviewed_by?: string;
    public published_at?: Date;
    public readonly created_at!: Date;
    public readonly updated_at!: Date;

    static associate(models: any) {
      Course.belongsTo(models.Department, {
        foreignKey: 'department_id',
        as: 'department',
      });
      Course.belongsTo(models.User, {
        foreignKey: 'teacher_id',
        as: 'teacher',
      });
      Course.belongsTo(models.User, {
        foreignKey: 'reviewed_by',
        as: 'reviewer',
      });
      Course.hasMany(models.CourseSection, {
        foreignKey: 'course_id',
        as: 'sections',
      });
      Course.hasMany(models.Enrollment, {
        foreignKey: 'course_id',
        as: 'enrollments',
      });
      Course.hasMany(models.Prerequisite, {
        foreignKey: 'course_id',
        as: 'prerequisites',
      });
      Course.hasMany(models.Prerequisite, {
        foreignKey: 'prerequisite_course_id',
        as: 'required_by',
      });
      Course.hasMany(models.ClassSchedule, {
        foreignKey: 'course_id',
        as: 'class_schedules',
      });
    }
  }

  Course.init(
    {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        comment: '课程ID',
      },
      course_code: {
        type: DataTypes.STRING(50),
        allowNull: false,
        unique: true,
        validate: {
          notEmpty: true,
        },
        comment: '课程代码',
      },
      course_number: {
        type: DataTypes.STRING(20),
        comment: '课程编号',
      },
      name: {
        type: DataTypes.STRING(200),
        allowNull: false,
        validate: {
          notEmpty: true,
        },
        comment: '课程名称',
      },
      english_name: {
        type: DataTypes.STRING(200),
        comment: '英文名称',
      },
      credit: {
        type: DataTypes.DECIMAL(3, 1),
        allowNull: false,
        validate: {
          min: 0.5,
          max: 10,
        },
        comment: '学分',
      },
      credit_hours: {
        type: DataTypes.INTEGER,
        allowNull: false,
        validate: {
          min: 1,
        },
        comment: '学时',
      },
      course_type: {
        type: DataTypes.ENUM(...Object.values(CourseType)),
        allowNull: false,
        comment: '课程类型',
      },
      department_id: {
        type: DataTypes.UUID,
        allowNull: false,
        comment: '开课院系ID',
        references: {
          model: 'departments',
          key: 'id',
        },
      },
      teacher_id: {
        type: DataTypes.UUID,
        allowNull: false,
        comment: '授课教师ID',
        references: {
          model: 'users',
          key: 'id',
        },
      },
      academic_year: {
        type: DataTypes.STRING(9),
        allowNull: false,
        validate: {
          is: /^\d{4}-\d{4}$/,
        },
        comment: '学年',
      },
      semester: {
        type: DataTypes.ENUM(...Object.values(Semester)),
        allowNull: false,
        comment: '学期',
      },
      capacity: {
        type: DataTypes.INTEGER,
        allowNull: false,
        validate: {
          min: 1,
        },
        comment: '课程容量',
      },
      min_quota: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 1,
        validate: {
          min: 1,
          max: function (value: number) {
            if (value > (this as any).capacity) {
              throw new Error(
                '最小开班人数不能超过课程容量'
              );
            }
          },
        },
        comment: '最小开班人数',
      },
      enrolled_count: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
        validate: {
          min: 0,
          max: function (value: number) {
            if (value > (this as any).capacity) {
              throw new Error('选课人数不能超过课程容量');
            }
          },
        },
        comment: '当前选课人数',
      },
      status: {
        type: DataTypes.ENUM(
          ...Object.values(CourseStatus)
        ),
        allowNull: false,
        defaultValue: CourseStatus.DRAFT,
        comment: '课程状态',
      },
      schedule: {
        type: DataTypes.JSONB,
        allowNull: false,
        defaultValue: {
          weekly: [],
          specific_dates: [],
        },
        comment: '时间安排',
      },
      location_type: {
        type: DataTypes.ENUM(
          ...Object.values(LocationType)
        ),
        allowNull: false,
        defaultValue: LocationType.CLASSROOM,
        comment: '上课地点类型',
      },
      location_details: {
        type: DataTypes.JSONB,
        defaultValue: {},
        comment: '地点详情',
      },
      description: {
        type: DataTypes.TEXT,
        comment: '课程描述',
      },
      objectives: {
        type: DataTypes.TEXT,
        comment: '教学目标',
      },
      syllabus: {
        type: DataTypes.TEXT,
        comment: '教学大纲',
      },
      assessment_method: {
        type: DataTypes.TEXT,
        comment: '考核方式',
      },
      textbook_reference: {
        type: DataTypes.TEXT,
        comment: '参考教材',
      },
      attachments: {
        type: DataTypes.JSONB,
        defaultValue: [],
        comment: '附件列表',
      },
      restrictions: {
        type: DataTypes.JSONB,
        defaultValue: {
          grade_limits: [],
          major_limits: [],
          prerequisites: [],
          conflict_courses: [],
        },
        comment: '限制条件',
      },
      view_count: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
        validate: {
          min: 0,
        },
        comment: '浏览次数',
      },
      favorite_count: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
        validate: {
          min: 0,
        },
        comment: '收藏次数',
      },
      review_notes: {
        type: DataTypes.TEXT,
        comment: '审核意见',
      },
      reviewed_at: {
        type: DataTypes.DATE,
        comment: '审核时间',
      },
      reviewed_by: {
        type: DataTypes.UUID,
        comment: '审核者ID',
        references: {
          model: 'users',
          key: 'id',
        },
      },
      published_at: {
        type: DataTypes.DATE,
        comment: '发布时间',
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '创建时间',
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '更新时间',
      },
    },
    {
      sequelize,
      modelName: 'Course',
      tableName: 'courses',
      underscored: true,
      timestamps: true,
      indexes: [
        {
          unique: true,
          fields: ['course_code'],
          name: 'courses_course_code_unique',
        },
        {
          fields: ['teacher_id'],
          name: 'courses_teacher_id_idx',
        },
        {
          fields: ['department_id'],
          name: 'courses_department_id_idx',
        },
        {
          fields: ['academic_year', 'semester'],
          name: 'courses_academic_year_semester_idx',
        },
        {
          fields: ['status', 'published_at'],
          name: 'courses_status_published_idx',
        },
        {
          fields: ['name'],
          name: 'courses_name_trgm_idx',
          using: 'gin',
          operator: 'gin_trgm_ops',
        },
        {
          fields: ['schedule'],
          name: 'courses_schedule_idx',
          using: 'gin',
        },
        {
          fields: ['restrictions'],
          name: 'courses_restrictions_idx',
          using: 'gin',
        },
      ],
      hooks: {
        beforeUpdate: (course: Course) => {
          // 当课程状态变为PUBLISHED时，设置发布时间
          if (
            course.changed('status') &&
            course.status === CourseStatus.PUBLISHED
          ) {
            course.published_at = new Date();
          }
        },
      },
    }
  );

  return Course;
}
```

### 2.6 选课记录模型 (`src/models/enrollment.model.ts`)

```typescript
import {
  DataTypes,
  Model,
  Optional,
  Sequelize,
} from 'sequelize';

export enum EnrollmentStatus {
  SELECTED = 'SELECTED',
  CONFIRMED = 'CONFIRMED',
  WITHDRAWN = 'WITHDRAWN',
  FAILED = 'FAILED',
  COMPLETED = 'COMPLETED',
}

export enum SelectionMethod {
  MANUAL = 'MANUAL',
  AUTO = 'AUTO',
  ADMIN = 'ADMIN',
}

export interface EnrollmentAttributes {
  id: string;
  student_id: string;
  course_id: string;
  section_id?: string;
  academic_year: string;
  semester: string;
  status: EnrollmentStatus;
  selection_round: number;
  selection_method: SelectionMethod;
  enrolled_at: Date;
  confirmed_at?: Date;
  withdrawn_at?: Date;
  completed_at?: Date;
  grade?: string;
  score?: number;
  gpa_points?: number;
  is_passed: boolean;
  teacher_comment?: string;
  student_feedback?: string;
  ip_address?: string;
  user_agent?: string;
  created_at: Date;
  updated_at: Date;
}

export interface EnrollmentCreationAttributes extends Optional<
  EnrollmentAttributes,
  | 'id'
  | 'selection_round'
  | 'selection_method'
  | 'enrolled_at'
  | 'is_passed'
  | 'created_at'
  | 'updated_at'
> {}

export default function EnrollmentModel(
  sequelize: Sequelize
) {
  class Enrollment
    extends Model<
      EnrollmentAttributes,
      EnrollmentCreationAttributes
    >
    implements EnrollmentAttributes
  {
    public id!: string;
    public student_id!: string;
    public course_id!: string;
    public section_id?: string;
    public academic_year!: string;
    public semester!: string;
    public status!: EnrollmentStatus;
    public selection_round!: number;
    public selection_method!: SelectionMethod;
    public enrolled_at!: Date;
    public confirmed_at?: Date;
    public withdrawn_at?: Date;
    public completed_at?: Date;
    public grade?: string;
    public score?: number;
    public gpa_points?: number;
    public is_passed!: boolean;
    public teacher_comment?: string;
    public student_feedback?: string;
    public ip_address?: string;
    public user_agent?: string;
    public readonly created_at!: Date;
    public readonly updated_at!: Date;

    static associate(models: any) {
      Enrollment.belongsTo(models.User, {
        foreignKey: 'student_id',
        as: 'student',
      });
      Enrollment.belongsTo(models.Course, {
        foreignKey: 'course_id',
        as: 'course',
      });
      Enrollment.belongsTo(models.CourseSection, {
        foreignKey: 'section_id',
        as: 'section',
      });
    }
  }

  Enrollment.init(
    {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        comment: '选课记录ID',
      },
      student_id: {
        type: DataTypes.UUID,
        allowNull: false,
        comment: '学生ID',
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      course_id: {
        type: DataTypes.UUID,
        allowNull: false,
        comment: '课程ID',
        references: {
          model: 'courses',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      section_id: {
        type: DataTypes.UUID,
        comment: '课程班次ID',
        references: {
          model: 'course_sections',
          key: 'id',
        },
        onDelete: 'SET NULL',
      },
      academic_year: {
        type: DataTypes.STRING(9),
        allowNull: false,
        validate: {
          is: /^\d{4}-\d{4}$/,
        },
        comment: '学年',
      },
      semester: {
        type: DataTypes.STRING(10),
        allowNull: false,
        comment: '学期',
      },
      status: {
        type: DataTypes.ENUM(
          ...Object.values(EnrollmentStatus)
        ),
        allowNull: false,
        defaultValue: EnrollmentStatus.SELECTED,
        comment: '选课状态',
      },
      selection_round: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 1,
        validate: {
          min: 1,
        },
        comment: '选课轮次',
      },
      selection_method: {
        type: DataTypes.ENUM(
          ...Object.values(SelectionMethod)
        ),
        allowNull: false,
        defaultValue: SelectionMethod.MANUAL,
        comment: '选课方式',
      },
      enrolled_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '选课时间',
      },
      confirmed_at: {
        type: DataTypes.DATE,
        comment: '确认时间',
      },
      withdrawn_at: {
        type: DataTypes.DATE,
        comment: '退课时间',
      },
      completed_at: {
        type: DataTypes.DATE,
        comment: '完成时间',
      },
      grade: {
        type: DataTypes.STRING(2),
        validate: {
          isIn: [['A', 'B', 'C', 'D', 'F', 'P', 'NP']],
        },
        comment: '成绩等级',
      },
      score: {
        type: DataTypes.DECIMAL(5, 2),
        validate: {
          min: 0,
          max: 100,
        },
        comment: '百分制成绩',
      },
      gpa_points: {
        type: DataTypes.DECIMAL(3, 2),
        validate: {
          min: 0,
          max: 5,
        },
        comment: '绩点',
      },
      is_passed: {
        type: DataTypes.VIRTUAL,
        get() {
          const grade = this.getDataValue('grade');
          const score = this.getDataValue('score');

          if (grade) {
            return ['A', 'B', 'C', 'D', 'P'].includes(
              grade
            );
          }
          if (score !== undefined && score !== null) {
            return score >= 60;
          }
          return false;
        },
        set(value: boolean) {
          // Virtual field, do nothing
        },
        comment: '是否通过',
      },
      teacher_comment: {
        type: DataTypes.TEXT,
        comment: '教师评语',
      },
      student_feedback: {
        type: DataTypes.TEXT,
        comment: '学生反馈',
      },
      ip_address: {
        type: DataTypes.INET,
        comment: 'IP地址',
      },
      user_agent: {
        type: DataTypes.TEXT,
        comment: '用户代理',
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '创建时间',
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
        comment: '更新时间',
      },
    },
    {
      sequelize,
      modelName: 'Enrollment',
      tableName: 'enrollments',
      underscored: true,
      timestamps: true,
      indexes: [
        {
          unique: true,
          fields: [
            'student_id',
            'course_id',
            'academic_year',
            'semester',
          ],
          name: 'enrollments_student_course_unique',
        },
        {
          fields: ['student_id'],
          name: 'enrollments_student_id_idx',
        },
        {
          fields: ['course_id'],
          name: 'enrollments_course_id_idx',
        },
        {
          fields: ['section_id'],
          name: 'enrollments_section_id_idx',
        },
        {
          fields: ['academic_year', 'semester'],
          name: 'enrollments_academic_year_semester_idx',
        },
        {
          fields: ['status'],
          name: 'enrollments_status_idx',
        },
        {
          fields: ['student_id', 'course_id', 'status'],
          name: 'enrollments_student_course_status_idx',
        },
        {
          fields: ['created_at'],
          name: 'enrollments_created_at_idx',
        },
        {
          fields: ['student_id'],
          where: {
            status: ['SELECTED', 'CONFIRMED'],
          },
          name: 'enrollments_active_idx',
        },
        {
          fields: ['student_id', 'is_passed', 'gpa_points'],
          name: 'enrollments_grades_idx',
        },
      ],
      hooks: {
        beforeSave: (enrollment: Enrollment) => {
          // 根据成绩计算是否通过
          if (
            enrollment.grade ||
            enrollment.score !== undefined
          ) {
            enrollment.is_passed = (() => {
              const grade = enrollment.grade;
              const score = enrollment.score;

              if (grade) {
                return ['A', 'B', 'C', 'D', 'P'].includes(
                  grade
                );
              }
              if (score !== undefined && score !== null) {
                return score >= 60;
              }
              return false;
            })();
          }

          // 根据状态更新时间戳
          if (enrollment.changed('status')) {
            const now = new Date();
            switch (enrollment.status) {
              case EnrollmentStatus.CONFIRMED:
                enrollment.confirmed_at = now;
                break;
              case EnrollmentStatus.WITHDRAWN:
                enrollment.withdrawn_at = now;
                break;
              case EnrollmentStatus.COMPLETED:
                enrollment.completed_at = now;
                break;
            }
          }
        },
      },
    }
  );

  return Enrollment;
}
```

## 3. 迁移脚本 (Migrations)

### 3.1 迁移脚本结构

```
databases/migrations/
├── 20240101000000-create-extension-uuid-ossp.ts
├── 20240101000001-create-extension-pgcrypto.ts
├── 20240101000002-create-extension-pg-trgm.ts
├── 20240102000000-create-users-table.ts
├── 20240102000001-create-user-profiles-table.ts
├── 20240102000002-create-departments-table.ts
├── 20240102000003-create-courses-table.ts
├── 20240102000004-create-course-sections-table.ts
├── 20240102000005-create-prerequisites-table.ts
├── 20240102000006-create-enrollments-table.ts
├── 20240102000007-create-enrollment-audit-log-table.ts
├── 20240102000008-create-class-schedules-table.ts
├── 20240102000009-create-notifications-table.ts
├── 20240102000010-create-system-configs-table.ts
├── 20240102000011-create-audit-logs-table.ts
└── 20240103000000-add-indexes-and-constraints.ts
```

### 3.2 创建 UUID 扩展迁移 (`20240101000000-create-extension-uuid-ossp.ts`)

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    await queryInterface.sequelize.query(
      'CREATE EXTENSION IF NOT EXISTS "uuid-ossp"'
    );
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.sequelize.query(
      'DROP EXTENSION IF EXISTS "uuid-ossp"'
    );
  },
};
```

### 3.3 创建 PGCRYPTO 扩展迁移 (`20240101000001-create-extension-pgcrypto.ts`)

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    await queryInterface.sequelize.query(
      'CREATE EXTENSION IF NOT EXISTS "pgcrypto"'
    );
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.sequelize.query(
      'DROP EXTENSION IF EXISTS "pgcrypto"'
    );
  },
};
```

### 3.4 创建 PG_TRGM 扩展迁移 (`20240101000002-create-extension-pg-trgm.ts`)

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    await queryInterface.sequelize.query(
      'CREATE EXTENSION IF NOT EXISTS "pg_trgm"'
    );
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.sequelize.query(
      'DROP EXTENSION IF EXISTS "pg_trgm"'
    );
  },
};
```

### 3.5 创建用户表迁移 (`20240102000000-create-users-table.ts`)

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    await queryInterface.createTable('users', {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        allowNull: false,
      },
      username: {
        type: DataTypes.STRING(50),
        allowNull: false,
        unique: true,
      },
      email: {
        type: DataTypes.STRING(100),
        allowNull: false,
        unique: true,
      },
      phone: {
        type: DataTypes.STRING(20),
        allowNull: true,
      },
      real_name: {
        type: DataTypes.STRING(50),
        allowNull: false,
      },
      avatar_url: {
        type: DataTypes.STRING(500),
        allowNull: true,
      },
      gender: {
        type: DataTypes.ENUM(
          'MALE',
          'FEMALE',
          'OTHER',
          'SECRET'
        ),
        allowNull: false,
        defaultValue: 'SECRET',
      },
      birth_date: {
        type: DataTypes.DATEONLY,
        allowNull: true,
      },
      student_id: {
        type: DataTypes.STRING(20),
        allowNull: true,
        unique: true,
      },
      teacher_id: {
        type: DataTypes.STRING(20),
        allowNull: true,
        unique: true,
      },
      department_id: {
        type: DataTypes.UUID,
        allowNull: true,
        references: {
          model: 'departments',
          key: 'id',
        },
        onDelete: 'SET NULL',
      },
      major: {
        type: DataTypes.STRING(100),
        allowNull: true,
      },
      grade: {
        type: DataTypes.INTEGER,
        allowNull: true,
        validate: {
          min: 1,
          max: 8,
        },
      },
      class_name: {
        type: DataTypes.STRING(50),
        allowNull: true,
      },
      password_hash: {
        type: DataTypes.STRING(255),
        allowNull: false,
      },
      role: {
        type: DataTypes.ENUM(
          'STUDENT',
          'TEACHER',
          'ADMIN',
          'SUPER_ADMIN'
        ),
        allowNull: false,
      },
      status: {
        type: DataTypes.ENUM(
          'ACTIVE',
          'INACTIVE',
          'SUSPENDED',
          'GRADUATED'
        ),
        allowNull: false,
        defaultValue: 'ACTIVE',
      },
      last_login_at: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      failed_login_attempts: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
      },
      locked_until: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      created_by: {
        type: DataTypes.UUID,
        allowNull: true,
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'SET NULL',
      },
      updated_by: {
        type: DataTypes.UUID,
        allowNull: true,
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'SET NULL',
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
    });

    // 创建基本索引
    await queryInterface.addIndex('users', ['username'], {
      name: 'users_username_unique',
      unique: true,
    });

    await queryInterface.addIndex('users', ['email'], {
      name: 'users_email_unique',
      unique: true,
    });

    await queryInterface.addIndex('users', ['student_id'], {
      name: 'users_student_id_unique',
      unique: true,
      where: {
        student_id: {
          [DataTypes.Op.ne]: null,
        },
      },
    });

    await queryInterface.addIndex('users', ['teacher_id'], {
      name: 'users_teacher_id_unique',
      unique: true,
      where: {
        teacher_id: {
          [DataTypes.Op.ne]: null,
        },
      },
    });
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.dropTable('users');
  },
};
```

### 3.6 创建课程表迁移 (`20240102000003-create-courses-table.ts`)

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    await queryInterface.createTable('courses', {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        allowNull: false,
      },
      course_code: {
        type: DataTypes.STRING(50),
        allowNull: false,
        unique: true,
      },
      course_number: {
        type: DataTypes.STRING(20),
        allowNull: true,
      },
      name: {
        type: DataTypes.STRING(200),
        allowNull: false,
      },
      english_name: {
        type: DataTypes.STRING(200),
        allowNull: true,
      },
      credit: {
        type: DataTypes.DECIMAL(3, 1),
        allowNull: false,
      },
      credit_hours: {
        type: DataTypes.INTEGER,
        allowNull: false,
      },
      course_type: {
        type: DataTypes.ENUM(
          'COMPULSORY',
          'ELECTIVE',
          'GENERAL',
          'EXPERIMENTAL',
          'PRACTICE'
        ),
        allowNull: false,
      },
      department_id: {
        type: DataTypes.UUID,
        allowNull: false,
        references: {
          model: 'departments',
          key: 'id',
        },
        onDelete: 'RESTRICT',
      },
      teacher_id: {
        type: DataTypes.UUID,
        allowNull: false,
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'RESTRICT',
      },
      academic_year: {
        type: DataTypes.STRING(9),
        allowNull: false,
      },
      semester: {
        type: DataTypes.ENUM(
          'FALL',
          'SPRING',
          'SUMMER',
          'WINTER'
        ),
        allowNull: false,
      },
      capacity: {
        type: DataTypes.INTEGER,
        allowNull: false,
      },
      min_quota: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 1,
      },
      enrolled_count: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
      },
      status: {
        type: DataTypes.ENUM(
          'DRAFT',
          'PENDING_REVIEW',
          'REJECTED',
          'PUBLISHED',
          'SELECTING',
          'SELECTION_ENDED',
          'IN_PROGRESS',
          'ENDED',
          'ARCHIVED'
        ),
        allowNull: false,
        defaultValue: 'DRAFT',
      },
      schedule: {
        type: DataTypes.JSONB,
        allowNull: false,
        defaultValue: {
          weekly: [],
          specific_dates: [],
        },
      },
      location_type: {
        type: DataTypes.ENUM(
          'CLASSROOM',
          'LAB',
          'ONLINE',
          'MIXED'
        ),
        allowNull: false,
        defaultValue: 'CLASSROOM',
      },
      location_details: {
        type: DataTypes.JSONB,
        allowNull: true,
        defaultValue: {},
      },
      description: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      objectives: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      syllabus: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      assessment_method: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      textbook_reference: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      attachments: {
        type: DataTypes.JSONB,
        allowNull: true,
        defaultValue: [],
      },
      restrictions: {
        type: DataTypes.JSONB,
        allowNull: true,
        defaultValue: {
          grade_limits: [],
          major_limits: [],
          prerequisites: [],
          conflict_courses: [],
        },
      },
      view_count: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
      },
      favorite_count: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
      },
      review_notes: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      reviewed_at: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      reviewed_by: {
        type: DataTypes.UUID,
        allowNull: true,
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'SET NULL',
      },
      published_at: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
    });

    // 创建索引
    await queryInterface.addIndex(
      'courses',
      ['course_code'],
      {
        name: 'courses_course_code_unique',
        unique: true,
      }
    );

    await queryInterface.addIndex(
      'courses',
      ['teacher_id'],
      {
        name: 'courses_teacher_id_idx',
      }
    );

    await queryInterface.addIndex(
      'courses',
      ['department_id'],
      {
        name: 'courses_department_id_idx',
      }
    );

    await queryInterface.addIndex(
      'courses',
      ['academic_year', 'semester'],
      {
        name: 'courses_academic_year_semester_idx',
      }
    );

    await queryInterface.addIndex(
      'courses',
      ['status', 'published_at'],
      {
        name: 'courses_status_published_idx',
      }
    );

    // 添加检查约束
    await queryInterface.sequelize.query(`
      ALTER TABLE courses
      ADD CONSTRAINT courses_credit_check 
      CHECK (credit >= 0.5 AND credit <= 10)
    `);

    await queryInterface.sequelize.query(`
      ALTER TABLE courses
      ADD CONSTRAINT courses_capacity_check 
      CHECK (capacity > 0)
    `);

    await queryInterface.sequelize.query(`
      ALTER TABLE courses
      ADD CONSTRAINT courses_min_quota_check 
      CHECK (min_quota >= 1 AND min_quota <= capacity)
    `);

    await queryInterface.sequelize.query(`
      ALTER TABLE courses
      ADD CONSTRAINT courses_enrolled_count_check 
      CHECK (enrolled_count >= 0 AND enrolled_count <= capacity)
    `);
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.dropTable('courses');
  },
};
```

### 3.7 创建选课记录表迁移 (`20240102000006-create-enrollments-table.ts`)

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    await queryInterface.createTable('enrollments', {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        allowNull: false,
      },
      student_id: {
        type: DataTypes.UUID,
        allowNull: false,
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      course_id: {
        type: DataTypes.UUID,
        allowNull: false,
        references: {
          model: 'courses',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      section_id: {
        type: DataTypes.UUID,
        allowNull: true,
        references: {
          model: 'course_sections',
          key: 'id',
        },
        onDelete: 'SET NULL',
      },
      academic_year: {
        type: DataTypes.STRING(9),
        allowNull: false,
      },
      semester: {
        type: DataTypes.STRING(10),
        allowNull: false,
      },
      status: {
        type: DataTypes.ENUM(
          'SELECTED',
          'CONFIRMED',
          'WITHDRAWN',
          'FAILED',
          'COMPLETED'
        ),
        allowNull: false,
        defaultValue: 'SELECTED',
      },
      selection_round: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 1,
      },
      selection_method: {
        type: DataTypes.ENUM('MANUAL', 'AUTO', 'ADMIN'),
        allowNull: false,
        defaultValue: 'MANUAL',
      },
      enrolled_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
      confirmed_at: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      withdrawn_at: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      completed_at: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      grade: {
        type: DataTypes.STRING(2),
        allowNull: true,
      },
      score: {
        type: DataTypes.DECIMAL(5, 2),
        allowNull: true,
      },
      gpa_points: {
        type: DataTypes.DECIMAL(3, 2),
        allowNull: true,
      },
      teacher_comment: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      student_feedback: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      ip_address: {
        type: DataTypes.INET,
        allowNull: true,
      },
      user_agent: {
        type: DataTypes.TEXT,
        allowNull: true,
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
      updated_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
    });

    // 创建唯一约束
    await queryInterface.addIndex(
      'enrollments',
      [
        'student_id',
        'course_id',
        'academic_year',
        'semester',
      ],
      {
        name: 'enrollments_student_course_unique',
        unique: true,
      }
    );

    // 创建索引
    await queryInterface.addIndex(
      'enrollments',
      ['student_id'],
      {
        name: 'enrollments_student_id_idx',
      }
    );

    await queryInterface.addIndex(
      'enrollments',
      ['course_id'],
      {
        name: 'enrollments_course_id_idx',
      }
    );

    await queryInterface.addIndex(
      'enrollments',
      ['section_id'],
      {
        name: 'enrollments_section_id_idx',
      }
    );

    await queryInterface.addIndex(
      'enrollments',
      ['academic_year', 'semester'],
      {
        name: 'enrollments_academic_year_semester_idx',
      }
    );

    await queryInterface.addIndex(
      'enrollments',
      ['status'],
      {
        name: 'enrollments_status_idx',
      }
    );

    await queryInterface.addIndex(
      'enrollments',
      ['student_id', 'course_id', 'status'],
      {
        name: 'enrollments_student_course_status_idx',
      }
    );

    await queryInterface.addIndex(
      'enrollments',
      ['created_at'],
      {
        name: 'enrollments_created_at_idx',
      }
    );

    // 创建部分索引（活跃选课）
    await queryInterface.sequelize.query(`
      CREATE INDEX enrollments_active_idx 
      ON enrollments(student_id) 
      WHERE status IN ('SELECTED', 'CONFIRMED')
    `);

    // 添加检查约束
    await queryInterface.sequelize.query(`
      ALTER TABLE enrollments
      ADD CONSTRAINT enrollments_selection_round_check 
      CHECK (selection_round >= 1)
    `);

    await queryInterface.sequelize.query(`
      ALTER TABLE enrollments
      ADD CONSTRAINT enrollments_score_check 
      CHECK (score IS NULL OR (score >= 0 AND score <= 100))
    `);

    await queryInterface.sequelize.query(`
      ALTER TABLE enrollments
      ADD CONSTRAINT enrollments_gpa_points_check 
      CHECK (gpa_points IS NULL OR (gpa_points >= 0 AND gpa_points <= 5))
    `);

    await queryInterface.sequelize.query(`
      ALTER TABLE enrollments
      ADD CONSTRAINT enrollments_grade_check 
      CHECK (grade IS NULL OR grade IN ('A', 'B', 'C', 'D', 'F', 'P', 'NP'))
    `);
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.dropTable('enrollments');
  },
};
```

### 3.8 创建通知表迁移 (`20240102000009-create-notifications-table.ts`)

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    await queryInterface.createTable('notifications', {
      id: {
        type: DataTypes.UUID,
        defaultValue: DataTypes.UUIDV4,
        primaryKey: true,
        allowNull: false,
      },
      recipient_id: {
        type: DataTypes.UUID,
        allowNull: false,
        references: {
          model: 'users',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      recipient_type: {
        type: DataTypes.ENUM('USER', 'GROUP', 'ALL'),
        allowNull: false,
        defaultValue: 'USER',
      },
      type: {
        type: DataTypes.STRING(50),
        allowNull: false,
      },
      title: {
        type: DataTypes.STRING(200),
        allowNull: false,
      },
      content: {
        type: DataTypes.TEXT,
        allowNull: false,
      },
      metadata: {
        type: DataTypes.JSONB,
        allowNull: true,
        defaultValue: {},
      },
      related_entity_type: {
        type: DataTypes.STRING(50),
        allowNull: true,
      },
      related_entity_id: {
        type: DataTypes.UUID,
        allowNull: true,
      },
      priority: {
        type: DataTypes.INTEGER,
        allowNull: false,
        defaultValue: 0,
      },
      is_read: {
        type: DataTypes.BOOLEAN,
        allowNull: false,
        defaultValue: false,
      },
      is_archived: {
        type: DataTypes.BOOLEAN,
        allowNull: false,
        defaultValue: false,
      },
      sent_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
      read_at: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      expires_at: {
        type: DataTypes.DATE,
        allowNull: true,
      },
      created_at: {
        type: DataTypes.DATE,
        allowNull: false,
        defaultValue: DataTypes.NOW,
      },
    });

    // 创建索引
    await queryInterface.addIndex(
      'notifications',
      ['recipient_id'],
      {
        name: 'notifications_recipient_id_idx',
      }
    );

    await queryInterface.addIndex(
      'notifications',
      ['type'],
      {
        name: 'notifications_type_idx',
      }
    );

    await queryInterface.addIndex(
      'notifications',
      ['is_read'],
      {
        name: 'notifications_is_read_idx',
      }
    );

    await queryInterface.addIndex(
      'notifications',
      ['sent_at'],
      {
        name: 'notifications_sent_at_idx',
      }
    );

    await queryInterface.addIndex(
      'notifications',
      ['related_entity_type', 'related_entity_id'],
      {
        name: 'notifications_related_entity_idx',
      }
    );

    // 创建复合索引
    await queryInterface.addIndex(
      'notifications',
      ['recipient_id', 'is_read', 'sent_at'],
      {
        name: 'user_notifications_idx',
      }
    );
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.dropTable('notifications');
  },
};
```

### 3.9 添加索引和约束迁移 (`20240103000000-add-indexes-and-constraints.ts`)

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    // 为用户表添加trgm索引
    await queryInterface.sequelize.query(`
      CREATE INDEX IF NOT EXISTS users_real_name_trgm_idx 
      ON users USING gin(real_name gin_trgm_ops)
    `);

    // 为课程表添加trgm索引
    await queryInterface.sequelize.query(`
      CREATE INDEX IF NOT EXISTS courses_name_trgm_idx 
      ON courses USING gin(name gin_trgm_ops)
    `);

    // 为课程表添加JSONB索引
    await queryInterface.sequelize.query(`
      CREATE INDEX IF NOT EXISTS courses_schedule_idx 
      ON courses USING gin(schedule)
    `);

    await queryInterface.sequelize.query(`
      CREATE INDEX IF NOT EXISTS courses_restrictions_idx 
      ON courses USING gin(restrictions)
    `);

    // 为院系表添加路径索引
    await queryInterface.sequelize.query(`
      CREATE INDEX IF NOT EXISTS departments_path_idx 
      ON departments(path)
    `);

    // 添加排除约束（防止课程时间冲突）
    await queryInterface.sequelize.query(`
      ALTER TABLE class_schedules
      ADD CONSTRAINT class_schedules_time_conflict_exclude
      EXCLUDE USING gist (
        course_id WITH =,
        weekday WITH =,
        tsrange(start_time, end_time) WITH &&
      ) WHERE (is_active = true)
    `);

    // 添加自定义函数和触发器
    await queryInterface.sequelize.query(`
      CREATE OR REPLACE FUNCTION update_updated_at_column()
      RETURNS TRIGGER AS $$
      BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
      END;
      $$ language 'plpgsql';
    `);

    // 为用户表添加更新时间触发器
    await queryInterface.sequelize.query(`
      CREATE TRIGGER update_users_updated_at
      BEFORE UPDATE ON users
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();
    `);

    // 为课程表添加更新时间触发器
    await queryInterface.sequelize.query(`
      CREATE TRIGGER update_courses_updated_at
      BEFORE UPDATE ON courses
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();
    `);

    // 为选课记录表添加更新时间触发器
    await queryInterface.sequelize.query(`
      CREATE TRIGGER update_enrollments_updated_at
      BEFORE UPDATE ON enrollments
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();
    `);

    // 添加计算字段（选课是否通过）
    await queryInterface.sequelize.query(`
      ALTER TABLE enrollments
      ADD COLUMN is_passed BOOLEAN GENERATED ALWAYS AS (
        CASE 
          WHEN grade IN ('A', 'B', 'C', 'D', 'P') THEN TRUE
          WHEN grade IN ('F', 'NP') THEN FALSE
          WHEN score >= 60 THEN TRUE
          ELSE FALSE
        END
      ) STORED;
    `);

    // 为计算字段创建索引
    await queryInterface.sequelize.query(`
      CREATE INDEX enrollments_grades_idx 
      ON enrollments(student_id, is_passed, gpa_points)
    `);
  },

  down: async (queryInterface: QueryInterface) => {
    // 删除触发器
    await queryInterface.sequelize.query(`
      DROP TRIGGER IF EXISTS update_users_updated_at ON users
    `);

    await queryInterface.sequelize.query(`
      DROP TRIGGER IF EXISTS update_courses_updated_at ON courses
    `);

    await queryInterface.sequelize.query(`
      DROP TRIGGER IF EXISTS update_enrollments_updated_at ON enrollments
    `);

    // 删除函数
    await queryInterface.sequelize.query(`
      DROP FUNCTION IF EXISTS update_updated_at_column()
    `);

    // 删除排除约束
    await queryInterface.sequelize.query(`
      ALTER TABLE class_schedules
      DROP CONSTRAINT IF EXISTS class_schedules_time_conflict_exclude
    `);

    // 删除trgm索引
    await queryInterface.sequelize.query(`
      DROP INDEX IF EXISTS users_real_name_trgm_idx
    `);

    await queryInterface.sequelize.query(`
      DROP INDEX IF EXISTS courses_name_trgm_idx
    `);

    // 删除JSONB索引
    await queryInterface.sequelize.query(`
      DROP INDEX IF EXISTS courses_schedule_idx
    `);

    await queryInterface.sequelize.query(`
      DROP INDEX IF EXISTS courses_restrictions_idx
    `);

    // 删除路径索引
    await queryInterface.sequelize.query(`
      DROP INDEX IF EXISTS departments_path_idx
    `);

    // 删除计算字段索引
    await queryInterface.sequelize.query(`
      DROP INDEX IF EXISTS enrollments_grades_idx
    `);

    // 删除计算字段
    await queryInterface.sequelize.query(`
      ALTER TABLE enrollments
      DROP COLUMN IF EXISTS is_passed
    `);
  },
};
```

## 4. 种子数据 (Seeders)

### 4.1 种子数据目录结构

```
databases/seeders/
├── 20240101000000-create-system-roles.ts
├── 20240101000001-create-super-admin.ts
├── 20240101000002-create-departments.ts
├── 20240101000003-create-admin-users.ts
├── 20240101000004-create-teacher-users.ts
├── 20240101000005-create-student-users.ts
├── 20240101000006-create-sample-courses.ts
├── 20240101000007-create-system-configs.ts
└── 20240101000008-create-selection-sessions.ts
```

### 4.2 创建系统角色种子 (`20240101000000-create-system-roles.ts`)

```typescript
import { QueryInterface } from 'sequelize';
import bcrypt from 'bcrypt';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    // 创建系统配置表（如果不存在）
    await queryInterface.bulkInsert(
      'system_configs',
      [
        {
          id: '00000000-0000-0000-0000-000000000001',
          config_key: 'system_roles',
          module: 'system',
          category: 'security',
          config_value: {
            roles: [
              {
                code: 'STUDENT',
                name: '学生',
                description:
                  '学生角色，可以进行选课、查看成绩等操作',
                permissions: [
                  'course:browse',
                  'enrollment:select',
                  'enrollment:withdraw',
                  'grade:view:self',
                  'schedule:view',
                  'profile:view',
                  'profile:edit',
                ],
              },
              {
                code: 'TEACHER',
                name: '教师',
                description:
                  '教师角色，可以创建课程、管理学生、录入成绩',
                permissions: [
                  'course:create',
                  'course:edit:own',
                  'course:delete:own',
                  'enrollment:view:own',
                  'grade:enter',
                  'grade:edit:own',
                  'notification:send:students',
                ],
              },
              {
                code: 'ADMIN',
                name: '管理员',
                description:
                  '管理员角色，可以管理用户、审核课程、查看统计',
                permissions: [
                  'user:manage',
                  'course:audit',
                  'department:manage',
                  'system:view:reports',
                  'selection:configure',
                  'notification:send:all',
                ],
              },
              {
                code: 'SUPER_ADMIN',
                name: '超级管理员',
                description:
                  '超级管理员角色，拥有系统全部权限',
                permissions: ['*'],
              },
            ],
          },
          value_type: 'OBJECT',
          description: '系统角色定义和权限配置',
          version: 1,
          scope: 'SYSTEM',
          is_encrypted: false,
          is_public: false,
          created_at: new Date(),
          updated_at: new Date(),
        },
      ],
      {}
    );
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.bulkDelete(
      'system_configs',
      {
        config_key: 'system_roles',
      },
      {}
    );
  },
};
```

### 4.3 创建超级管理员种子 (`20240101000001-create-super-admin.ts`)

```typescript
import { QueryInterface } from 'sequelize';
import bcrypt from 'bcrypt';
import { v4 as uuidv4 } from 'uuid';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    const password = await bcrypt.hash('admin123', 10);
    const adminId = uuidv4();

    // 创建超级管理员用户
    await queryInterface.bulkInsert(
      'users',
      [
        {
          id: adminId,
          username: 'superadmin',
          email: 'admin@course-select.edu',
          phone: '13800138000',
          real_name: '系统管理员',
          avatar_url: null,
          gender: 'SECRET',
          birth_date: null,
          student_id: null,
          teacher_id: 'T000001',
          department_id: null,
          major: null,
          grade: null,
          class_name: null,
          password_hash: password,
          role: 'SUPER_ADMIN',
          status: 'ACTIVE',
          last_login_at: null,
          failed_login_attempts: 0,
          locked_until: null,
          created_by: adminId,
          updated_by: adminId,
          created_at: new Date(),
          updated_at: new Date(),
        },
      ],
      {}
    );

    // 创建管理员资料
    await queryInterface.bulkInsert(
      'user_profiles',
      [
        {
          id: uuidv4(),
          user_id: adminId,
          education_background: [],
          bio: '系统超级管理员，负责系统维护和管理',
          research_interests: [],
          office_location: '行政楼301',
          office_hours: '周一至周五 9:00-17:00',
          social_links: {},
          preferences: {
            notification: {
              email: true,
              sms: false,
              push: true,
            },
            theme: 'light',
            language: 'zh-CN',
          },
          total_credits: 0,
          gpa: null,
          created_at: new Date(),
          updated_at: new Date(),
        },
      ],
      {}
    );
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.bulkDelete(
      'user_profiles',
      {
        user_id: (
          await queryInterface.sequelize.query(
            "SELECT id FROM users WHERE username = 'superadmin'"
          )
        )[0][0]?.id,
      },
      {}
    );

    await queryInterface.bulkDelete(
      'users',
      {
        username: 'superadmin',
      },
      {}
    );
  },
};
```

### 4.4 创建院系种子 (`20240101000002-create-departments.ts`)

```typescript
import { QueryInterface } from 'sequelize';
import { v4 as uuidv4 } from 'uuid';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    const adminId = (
      await queryInterface.sequelize.query(
        "SELECT id FROM users WHERE username = 'superadmin' LIMIT 1"
      )
    )[0][0]?.id;

    // 创建顶级院系
    const departments = [
      {
        id: uuidv4(),
        code: 'CS',
        name: '计算机科学与技术学院',
        full_name: '计算机科学与技术学院',
        description: '计算机科学与技术相关专业的教学和研究',
        parent_id: null,
        level: 1,
        path: null,
        contact_person: '张院长',
        contact_phone: '010-62780001',
        contact_email: 'cs@university.edu',
        location: '信息楼',
        status: 'ACTIVE',
        display_order: 1,
        created_by: adminId,
        updated_by: adminId,
        created_at: new Date(),
        updated_at: new Date(),
      },
      {
        id: uuidv4(),
        code: 'MA',
        name: '数学科学学院',
        full_name: '数学科学学院',
        description: '数学理论与应用研究',
        parent_id: null,
        level: 1,
        path: null,
        contact_person: '李院长',
        contact_phone: '010-62780002',
        contact_email: 'math@university.edu',
        location: '数理楼',
        status: 'ACTIVE',
        display_order: 2,
        created_by: adminId,
        updated_by: adminId,
        created_at: new Date(),
        updated_at: new Date(),
      },
      {
        id: uuidv4(),
        code: 'PH',
        name: '物理学院',
        full_name: '物理学院',
        description: '物理学教学与研究',
        parent_id: null,
        level: 1,
        path: null,
        contact_person: '王院长',
        contact_phone: '010-62780003',
        contact_email: 'physics@university.edu',
        location: '物理楼',
        status: 'ACTIVE',
        display_order: 3,
        created_by: adminId,
        updated_by: adminId,
        created_at: new Date(),
        updated_at: new Date(),
      },
      {
        id: uuidv4(),
        code: 'CH',
        name: '化学学院',
        full_name: '化学学院',
        description: '化学教学与研究',
        parent_id: null,
        level: 1,
        path: null,
        contact_person: '赵院长',
        contact_phone: '010-62780004',
        contact_email: 'chemistry@university.edu',
        location: '化学楼',
        status: 'ACTIVE',
        display_order: 4,
        created_by: adminId,
        updated_by: adminId,
        created_at: new Date(),
        updated_at: new Date(),
      },
      {
        id: uuidv4(),
        code: 'BU',
        name: '商学院',
        full_name: '商学院',
        description: '商业管理教学与研究',
        parent_id: null,
        level: 1,
        path: null,
        contact_person: '钱院长',
        contact_phone: '010-62780005',
        contact_email: 'business@university.edu',
        location: '商学院大楼',
        status: 'ACTIVE',
        display_order: 5,
        created_by: adminId,
        updated_by: adminId,
        created_at: new Date(),
        updated_at: new Date(),
      },
    ];

    await queryInterface.bulkInsert(
      'departments',
      departments,
      {}
    );

    // 更新路径信息
    for (const dept of departments) {
      await queryInterface.sequelize.query(`
        UPDATE departments 
        SET path = '${dept.id}' 
        WHERE id = '${dept.id}'
      `);
    }
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.bulkDelete(
      'departments',
      {
        code: ['CS', 'MA', 'PH', 'CH', 'BU'],
      },
      {}
    );
  },
};
```

### 4.5 创建示例课程种子 (`20240101000006-create-sample-courses.ts`)

```typescript
import { QueryInterface } from 'sequelize';
import { v4 as uuidv4 } from 'uuid';

module.exports = {
  up: async (queryInterface: QueryInterface) => {
    // 获取计算机学院和教师ID
    const [csDept] = (
      await queryInterface.sequelize.query(
        "SELECT id FROM departments WHERE code = 'CS' LIMIT 1"
      )
    )[0] as any[];

    const [teacher] = (
      await queryInterface.sequelize.query(
        "SELECT id FROM users WHERE role = 'TEACHER' LIMIT 1"
      )
    )[0] as any[];

    if (!csDept || !teacher) {
      console.log('院系或教师不存在，跳过课程创建');
      return;
    }

    const courses = [
      {
        id: uuidv4(),
        course_code: 'CS101',
        course_number: '101',
        name: '计算机科学导论',
        english_name: 'Introduction to Computer Science',
        credit: 3.0,
        credit_hours: 48,
        course_type: 'COMPULSORY',
        department_id: csDept.id,
        teacher_id: teacher.id,
        academic_year: '2024-2025',
        semester: 'FALL',
        capacity: 100,
        min_quota: 10,
        enrolled_count: 0,
        status: 'PUBLISHED',
        schedule: {
          weekly: [
            {
              weekday: 1,
              start_time: '08:00',
              end_time: '09:50',
              location: '信息楼101',
            },
            {
              weekday: 3,
              start_time: '10:10',
              end_time: '12:00',
              location: '信息楼101',
            },
          ],
          specific_dates: [],
        },
        location_type: 'CLASSROOM',
        location_details: {
          building: '信息楼',
          room: '101',
          capacity: 120,
          equipment: ['投影仪', '白板', '计算机'],
        },
        description:
          '本课程介绍计算机科学的基本概念、历史发展和主要领域。',
        objectives:
          '使学生了解计算机科学的基本概念和发展历程，为后续专业课程学习打下基础。',
        syllabus:
          '1. 计算机科学概述\n2. 计算机硬件基础\n3. 计算机软件基础\n4. 算法与数据结构简介\n5. 计算机网络简介\n6. 人工智能简介',
        assessment_method:
          '平时成绩30% + 期中考试30% + 期末考试40%',
        textbook_reference:
          '《计算机科学导论》（第3版），张三，清华大学出版社',
        attachments: [],
        restrictions: {
          grade_limits: [1, 2],
          major_limits: ['计算机科学与技术', '软件工程'],
          prerequisites: [],
          conflict_courses: [],
        },
        view_count: 0,
        favorite_count: 0,
        review_notes: null,
        reviewed_at: new Date(),
        reviewed_by: (
          await queryInterface.sequelize.query(
            "SELECT id FROM users WHERE username = 'superadmin' LIMIT 1"
          )
        )[0][0]?.id,
        published_at: new Date(),
        created_at: new Date(),
        updated_at: new Date(),
      },
      {
        id: uuidv4(),
        course_code: 'CS201',
        course_number: '201',
        name: '数据结构与算法',
        english_name: 'Data Structures and Algorithms',
        credit: 4.0,
        credit_hours: 64,
        course_type: 'COMPULSORY',
        department_id: csDept.id,
        teacher_id: teacher.id,
        academic_year: '2024-2025',
        semester: 'FALL',
        capacity: 80,
        min_quota: 15,
        enrolled_count: 0,
        status: 'PUBLISHED',
        schedule: {
          weekly: [
            {
              weekday: 2,
              start_time: '14:00',
              end_time: '15:50',
              location: '信息楼201',
            },
            {
              weekday: 4,
              start_time: '14:00',
              end_time: '15:50',
              location: '信息楼201',
            },
          ],
          specific_dates: [],
        },
        location_type: 'CLASSROOM',
        location_details: {
          building: '信息楼',
          room: '201',
          capacity: 100,
          equipment: ['投影仪', '白板', '计算机'],
        },
        description:
          '本课程介绍常用数据结构和基本算法设计分析方法。',
        objectives:
          '使学生掌握基本数据结构和算法的设计与分析方法，提高编程能力。',
        syllabus:
          '1. 算法分析基础\n2. 线性表\n3. 栈和队列\n4. 树和二叉树\n5. 图\n6. 排序算法\n7. 查找算法',
        assessment_method:
          '平时成绩20% + 实验30% + 期末考试50%',
        textbook_reference:
          '《数据结构（C语言版）》，严蔚敏，清华大学出版社',
        attachments: [],
        restrictions: {
          grade_limits: [2, 3],
          major_limits: ['计算机科学与技术', '软件工程'],
          prerequisites: ['CS101'],
          conflict_courses: [],
        },
        view_count: 0,
        favorite_count: 0,
        review_notes: null,
        reviewed_at: new Date(),
        reviewed_by: (
          await queryInterface.sequelize.query(
            "SELECT id FROM users WHERE username = 'superadmin' LIMIT 1"
          )
        )[0][0]?.id,
        published_at: new Date(),
        created_at: new Date(),
        updated_at: new Date(),
      },
      {
        id: uuidv4(),
        course_code: 'CS301',
        course_number: '301',
        name: '数据库系统原理',
        english_name: 'Database System Principles',
        credit: 3.0,
        credit_hours: 48,
        course_type: 'COMPULSORY',
        department_id: csDept.id,
        teacher_id: teacher.id,
        academic_year: '2024-2025',
        semester: 'FALL',
        capacity: 60,
        min_quota: 10,
        enrolled_count: 0,
        status: 'PUBLISHED',
        schedule: {
          weekly: [
            {
              weekday: 3,
              start_time: '14:00',
              end_time: '15:50',
              location: '信息楼301',
            },
            {
              weekday: 5,
              start_time: '10:10',
              end_time: '12:00',
              location: '信息楼301',
            },
          ],
          specific_dates: [],
        },
        location_type: 'CLASSROOM',
        location_details: {
          building: '信息楼',
          room: '301',
          capacity: 80,
          equipment: [
            '投影仪',
            '白板',
            '计算机',
            '数据库服务器',
          ],
        },
        description:
          '本课程介绍数据库系统的基本原理、设计方法和应用技术。',
        objectives:
          '使学生掌握数据库系统的基本原理和设计方法，能够进行数据库应用系统开发。',
        syllabus:
          '1. 数据库系统概述\n2. 关系数据模型\n3. SQL语言\n4. 数据库设计\n5. 事务管理\n6. 数据库安全',
        assessment_method:
          '平时成绩30% + 课程设计30% + 期末考试40%',
        textbook_reference:
          '《数据库系统概念》（第7版），Abraham Silberschatz等，机械工业出版社',
        attachments: [],
        restrictions: {
          grade_limits: [3, 4],
          major_limits: ['计算机科学与技术', '软件工程'],
          prerequisites: ['CS201'],
          conflict_courses: [],
        },
        view_count: 0,
        favorite_count: 0,
        review_notes: null,
        reviewed_at: new Date(),
        reviewed_by: (
          await queryInterface.sequelize.query(
            "SELECT id FROM users WHERE username = 'superadmin' LIMIT 1"
          )
        )[0][0]?.id,
        published_at: new Date(),
        created_at: new Date(),
        updated_at: new Date(),
      },
    ];

    await queryInterface.bulkInsert('courses', courses, {});
  },

  down: async (queryInterface: QueryInterface) => {
    await queryInterface.bulkDelete(
      'courses',
      {
        course_code: ['CS101', 'CS201', 'CS301'],
      },
      {}
    );
  },
};
```

## 5. Sequelize CLI 操作脚本

### 5.1 Package.json 脚本配置

```json
{
  "scripts": {
    "db:init": "sequelize db:create",
    "db:drop": "sequelize db:drop",
    "db:migrate": "sequelize db:migrate",
    "db:migrate:undo": "sequelize db:migrate:undo",
    "db:migrate:undo:all": "sequelize db:migrate:undo:all",
    "db:migrate:status": "sequelize db:migrate:status",
    "db:seed": "sequelize db:seed:all",
    "db:seed:undo": "sequelize db:seed:undo:all",
    "db:seed:undo:one": "sequelize db:seed:undo --seed <seed-name>",
    "db:seed:create": "sequelize seed:generate --name",
    "db:migrate:create": "sequelize migration:generate --name",
    "db:model:create": "sequelize model:generate --name",
    "db:reset": "pnpm run db:drop && pnpm run db:init && pnpm run db:migrate && pnpm run db:seed",
    "db:refresh": "pnpm run db:migrate:undo:all && pnpm run db:migrate && pnpm run db:seed",
    "db:schema:dump": "sequelize db:schema:dump",
    "db:setup": "pnpm run db:init && pnpm run db:migrate && pnpm run db:seed"
  }
}
```

### 5.2 数据库初始化脚本

```bash
#!/bin/bash
# scripts/init-db.sh

echo "🚀 开始初始化数据库..."

# 加载环境变量
if [ -f .env ]; then
  export $(cat .env | grep -v '^#' | xargs)
fi

# 检查数据库是否存在
DB_EXISTS=$(psql -U $DB_USER -h $DB_HOST -p $DB_PORT -tAc "SELECT 1 FROM pg_database WHERE datname='$DB_NAME'")

if [ "$DB_EXISTS" = "1" ]; then
  echo "⚠️  数据库已存在，跳过创建"
else
  echo "📦 创建数据库..."
  createdb -U $DB_USER -h $DB_HOST -p $DB_PORT $DB_NAME || {
    echo "❌ 创建数据库失败"
    exit 1
  }
fi

echo "🔧 运行数据库迁移..."
pnpm run db:migrate || {
  echo "❌ 数据库迁移失败"
  exit 1
}

echo "🌱 运行种子数据..."
pnpm run db:seed || {
  echo "❌ 种子数据插入失败"
  exit 1
}

echo "✅ 数据库初始化完成！"
```

### 5.3 Docker Compose 数据库服务

```yaml
# databases/docker-compose.db.yml
version: '3.9'
services:
  postgres:
    image: postgres:15-alpine
    container_name: course_pg
    ports:
      - '55432:5432'
    environment:
      POSTGRES_USER: course_admin
      POSTGRES_PASSWORD: password
      POSTGRES_DB: course_select
    volumes:
      - ./data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    restart: unless-stopped
```

## 6. 使用说明

### 6.1 初始化项目

```bash
# 1. 启动数据库容器
docker compose -f databases/docker-compose.db.yml up -d

# 数据库连接参数请在 packages/config 中维护，不使用根环境变量文件

# 2. 在仓库根目录执行迁移与种子
pnpm run db:migrate   # 运行迁移（databases/migrations）
pnpm run db:seed      # 插入种子数据（databases/seeders）
```

### 6.2 常用命令

```bash
# 创建新迁移
pnpm run db:migrate:create -- create-new-table

# 创建新种子
pnpm run db:seed:create -- add-sample-data

# 创建新模型
pnpm run db:model:create -- NewModel

# 查看迁移状态
pnpm run db:migrate:status

# 回滚最近一次迁移
pnpm run db:migrate:undo

# 回滚所有迁移
pnpm run db:migrate:undo:all

# 重置数据库（删除并重建）
pnpm run db:reset

# 刷新数据库（回滚所有迁移后重新迁移）
pnpm run db:refresh
```

### 6.3 开发工作流程

```bash
# 1. 开始新功能开发时，创建迁移文件
pnpm run db:migrate:create -- add-new-feature-table

# 2. 编辑生成的迁移文件
# 编辑 databases/migrations/xxx-add-new-feature-table.ts

# 3. 运行迁移
pnpm run db:migrate

# 4. 创建对应的模型
pnpm run db:model:create -- NewFeature

# 5. 编辑模型文件
# 编辑 apps/backend/src/models/new-feature.model.ts

# 6. 如果需要测试数据，创建种子
pnpm run db:seed:create -- new-feature-test-data

# 7. 开发完成后，运行所有测试
pnpm test

# 8. 部署前，确保所有迁移已运行
pnpm run db:migrate:status
```

## 7. 最佳实践

### 7.1 迁移脚本编写规范

1. **原子性**：每个迁移应该只完成一个逻辑变更
2. **可逆性**：每个迁移都应该有对应的撤销操作
3. **幂等性**：迁移应该可以安全地重复运行
4. **顺序性**：迁移文件名使用时间戳保证执行顺序
5. **注释**：在迁移中添加必要的注释说明

### 7.2 模型定义规范

1. **类型安全**：使用 TypeScript 接口定义属性
2. **数据验证**：在模型层面进行数据验证
3. **关联清晰**：明确定义模型间的关联关系
4. **索引优化**：根据查询模式添加合适的索引
5. **钩子使用**：合理使用生命周期钩子

### 7.3 种子数据规范

1. **独立性**：每个种子文件应该独立运行
2. **可重复性**：种子数据应该可以重复插入
3. **测试数据**：只包含必要的测试数据
4. **性能考虑**：大量数据时使用批量插入
5. **清理数据**：确保撤销操作能正确清理数据

## 8. 故障排查

### 8.1 常见问题

```bash
# 问题1: 迁移失败，表已存在
# 解决: 先回滚迁移，再重新运行
pnpm run db:migrate:undo
pnpm run db:migrate

# 问题2: 连接数据库失败
# 检查: 1. 环境变量配置 2. 数据库服务状态 3. 网络连接

# 问题3: 模型关联错误
# 检查: 1. 外键约束 2. 关联定义 3. 数据完整性

# 问题4: 种子数据冲突
# 解决: 先清理种子数据，再重新插入
pnpm run db:seed:undo
pnpm run db:seed
```

### 8.2 调试技巧

```typescript
// 在迁移文件中添加调试日志
module.exports = {
  up: async (queryInterface: QueryInterface) => {
    console.log('开始执行迁移...');
    try {
      // 迁移逻辑
      console.log('迁移完成');
    } catch (error) {
      console.error('迁移失败:', error);
      throw error;
    }
  },
};

// 在模型中使用调试
const models = loadModels(sequelize);
sequelize
  .sync({ force: false, alter: true })
  .then(() => {
    console.log('模型同步完成');
  })
  .catch(error => {
    console.error('模型同步失败:', error);
  });
```

这个 Sequelize CLI 配置提供了完整的数据库迁移、模型定义和种子数据管理方案，支持 TypeScript 和 PostgreSQL 数据库，符合项目架构要求。
